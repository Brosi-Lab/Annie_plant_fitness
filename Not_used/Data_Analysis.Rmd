---
title: "Data_Analysis"
author: "Annie Schiffer"
date: "12/2/2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is one document for all of my ongoing analyses. Other Markdown documents may be created from this document, but all of my data analysis is located in this central location.

## Phenology Analyses

"Delph.glmer this is a name that you are assigning to the output of the model. It can basically be anything.

glmer() this is the function in the lme4 package you are using

total.seeds response variable. I assume this is the right column in your data set? Swap it out with another column name if not.

relative.position explanatory variable (fixed effect). I assume this is the right column in your data set? Swap it out with another column name if not.

plot.treat another fixed effect. This one is kind of a judgment call, as it could be considered instead a random effect, but I think this is better. We can discuss.

(1|site) random effect (random intercept specifically)

family = “Poisson” error structure. We are assuming the errors follow the Poisson distribution given that we are dealing with discrete counts that cannot be less than zero. We will later have to check the assumptions that go along with this. Let’s start with this and we could go from there to doing binomial errors for delph & mertensia

data = delph the dataset you are using. Note that I called it “delph” when importing it above. If you call it something different when importing, call it that name here.

na.action = na.omit tells R to ignore any NA or missing values. You might have to go back and just remove them manually. Might want to check some of the particular values to make sure they are actually being interpreted as NAs by R, using the “is.na” function."

### Delphinium

```{r Delphinium mixed effects model}
#install.packages("lme4")
library(lme4) # this you need to do in every R session 
delph = read.csv("Delphinium_final2.csv") # read in the data
Delph.glmer = glmer(total.seeds ~ relative.position + plot.treat + (1|site), family = poisson, data = delph, na.action = na.omit) # this is the model
summary(Delph.glmer)
```

### Mertensia

```{r Mertensia mixed effects model}
#install.packages("lme4")
library(lme4) # this you need to do in every R session 
mert = read.csv("Mertensia_final2.csv") # read in the data
Mert.glmer = glmer(total.seeds ~ relative.position + plot.treat + (1|site), family = poisson, data = mert, na.action = na.omit) # this is the model
summary(Mert.glmer)
```

### Potentilla

```{r Potentilla mixed effects model}
#install.packages("lme4")
library(lme4) # this you need to do in every R session 
pot = read.csv("Potentilla_final2.csv") # read in the data
Pot.glmer = glmer(total.seeds ~ relative.position + plot.treat + (1|site), family = poisson, data = pot, na.action = na.omit) # this is the model
summary(Pot.glmer)
```

# Soil Moisture Analyses

We began by importing the seed data containing phenology estimates, soil moisture variables, and seed counts for every individual of Mertensia. We removed NAs from the seed count column.

```{r importing data}
masterdata=read.csv("Mertensia_final.csv")
seed.data=masterdata[!is.na(masterdata$total.seeds),]
```

The seed counts fit a negative binomial distribution, a common distribution for count data. 

```{r checking distribution}
library(fitdistrplus)
#pois<-fitdist(seed.data$total.seeds,"pois")
#plot(pois)

nbinom<-fitdist(seed.data$total.seeds,"nbinom")
plot(nbinom)
```

The glmmADMB package is the best for running analyses on negative bionomial-distributed data.

```{r Install package glmmADMB}
#install.packages("R2admb") 
#install.packages("glmmADMB",
#   repos=c("http://glmmadmb.r-forge.r-project.org/repos",
#        getOption("repos")), type="source")
library(glmmADMB)
```

A few of the soil moisture variables are correlated, such as effective start date and range. We ran a correlation matrix for Mertensia to see the correlations among the variables.

```{r correlation matrix for Mertensia sites}
soilcorrelat<-cor(seed.data[,4:11],method = "pearson")
soilcorrelat
```

Now that we know how to do it with Mertensia sites, we want to run the correlation test for all of the sites.

```{r correlation matrix for all sites}
test<-read.csv("~/Documents/BROSI/THESIS/Data Cleaning/Soil_Moisture_by_Site.csv")
totalcorrelat<-cor(test[,c(6,9:12)],method = "pearson")
totalcorrelat
write.csv(totalcorrelat,"Soil_Correlation_Total.csv")
```

And we want to visualize the correlation matrix better.

```{r correlation plot}
#install.packages("corrplot")
library(corrplot)
source("http://www.sthda.com/upload/rquery_cormat.r")
rquery.cormat(seed.data[4:11])
rquery.cormat(seed.data[c(4,7:11)])
rquery.cormat(totalcorrelat)
```

To understand which variables are most influential for seed production, we will run a generalized linear mixed model with all of the soil moisture variables. Site and plot treatment are random effects, while the soil moisture variables are fixed effects. The family is negative binomial because the data have a negative binomial distribution.

```{r Run GLMM with glmmADMB}
mod1 <- glmmadmb(total.seeds ~ mean+rate+effect.min+end+range+(1|site/plot.treat), family = "nbinom2", data = seed.data)
summary(mod1)
```

Now we can use the dredge function for our model selection. 

```{r installing MuMIn package}
#install.packages("MuMIn")
library(MuMIn)
dredge_result<-dredge(mod1)
subset(dredge_result, delta<4)
```