---
title: "Phenology and Plant Fitness"
author: "Annie Schiffer"
date: "started 27 January 2020; most recent edits `r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

This project aims to connect floral phenology to reproductive success on the individual level and landscape level for three subalpine plants. Data were collected at the Rocky Mountain Biological Laboratory during the 2019 field season. Focal species include Mertensia fusiformis, Potentilla pulcherrima, and Delphinium nuttalianum. 

Our questions specifically ask: 
  1. how does blooming time affect seed set for individiuals in a population?
  2. how does blooming time of populations affect seed set compared to other populations in a landscape?
  3. how does accelerated snowmelt affect phenology and seed set on the individual and population level?
  
Individuals of the three species were tagged in control and manipulated plots in eight sites across East River valley and Washington Gulch. Seed set was quantified as the count of total developed seeds in each individual. 

Because there were sources of non-independence in this study, our statistical approach involves generalized linear mixed effects models. Before we ran these models, we converted phenological data to a "relative position" value that represents how many days before or after the community peak the individual was in bloom....

# Load Packages

```{r packages}
suppressWarnings(suppressPackageStartupMessages(require(knitr)))
suppressWarnings(suppressPackageStartupMessages(require(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(require(lme4)))
suppressWarnings(suppressPackageStartupMessages(require(ggplot2)))
suppressWarnings(suppressPackageStartupMessages(require(RColorBrewer)))
suppressWarnings(suppressPackageStartupMessages(require(fitdistrplus)))
suppressWarnings(suppressPackageStartupMessages(require(glmmADMB)))
```

# Data Import & Basic Formatting

The imported csv files contain the following for each individual of a species: bloom start and end estimates, relative position of blooming in the community, soil moisture variables, and seed counts. These elements were compiled from five different data sets and calculated in a separate document. To view the data cleaning process, refer to the data cleaning R Markdown file. 

## Mertensia Data

The first dataset contains the individual data for Mertensia fusiformis, which was found in four of our sites. No further data formatting is necessary.

```{r Mertensia data import}
mert = read.csv("Mertensia_final2.csv") # read in Mertensia data
mert<-mert[!is.na(mert$total.seeds),] #removing NA values from Mertenia total seed column
mert<-mert[!is.na(mert$relative.position),] #removing NA values from relative position column
mert$prop.dev.seeds<-(mert$dev.seed/mert$total.seeds) #adding proportion of developed seeds
```

## Delphinium Data

The second dataset contains individual data for Delphinium nuttalianum. Delphinium was found in four of our sites. No further formatting is necessary. 

```{r Delphinium data import}
delph = read.csv("Delphinium_final2.csv") # read in Delphinium data
delph<-delph[!is.na(delph$total.seeds),] #removing NA values in seed column
delph<-delph[!is.na(delph$relative.position),] #removing NA values in the relative position
delph$prop.dev.seeds<-(delph$total.seeds/(delph$undev.seed1+delph$undev.seed+delph$total.seeds)) #adding proportion of developed seeds
```

## Potentilla Data

The third dataset contains Potentilla pulcherrima data. Potentilla was set up in all but one of our sites. 

```{r Potentilla data import}
pot = read.csv("Potentilla_final2.csv") # read in Potentilla data
pot<-pot[-119,] #removing one row with NA in treatment column
pot<-pot[!is.na(pot$relative.position),] #removing NA values in relative position
pot<-pot[!is.na(pot$total.seeds),] #removing NA values in total seeds column
```

Because many of the Potentilla individuals were still in bloom when we finished our field season, we had to calculate a midpoint and relative position based on those individuals that had senesced. A key factor that determines duration of blooming is the number of flowers on the individual. The data imported includes those relative position estimates for the individuals that didn't senesce before we finished our field season. For more information on how those numbers were calculated, see Data_Cleaning.Rmd.


# Mixed Effects Models with Count Data

Generalized linear mixed effects models were appropriate for this analysis because the data contain sources of non-independence. Individual plants were located in the same site as other individuals and were likely genetically similar. Therefore, we considered site a random effect. 

The response variable is total seeds, which is discrete and non-zero. Relative position and plot treatment were considered fixed effects. We are assuming Poisson errors for this analysis because the data are discrete counts. Each species is analyzed separately. 

## Mertensia

We started by checking the distribution of the total seed counts.

```{r checking Mertensia distribution}
mert.nbinom<-fitdist(mert$total.seeds, "nbinom") #fitting Mertensia data to negative binomial distribution using fitdistplus
plot(mert.nbinom) #plotting to see the fit
```

The Mertensia seed data fits a negative binomial distribution. The glmmADMB package is the best for modeling data with a negative binomial fit.

```{r Mertensia glmmadmb}
mert.glmmadmb<-glmmadmb(total.seeds ~ relative.position  + (1|site/plot.treat), family = "nbinom2", data = mert) #Mertensia model for negative binomial data with glmmadmb package
summary(mert.glmmadmb) #summary of model output
```

Treating plot treatment as a random effect or as a separate fixed effect didn't produce any significant results. The interaction between relative position and plot treatment also didn't produce significant results.

Below is the plot of seed set vs. relative position of blooming in the community for Mertensia individuals. Plot treatment is indicated by individual color, and treatment received (open or pollen-supplemented) is indicated by individual shape.

```{r Mertensia plot}
ggplot(mert, aes(x=mert$relative.position, y=mert$total.seeds)) +
  labs(y="Total Developed Seeds",x="Relative Position in Population Phenology") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkgreen","manip"="darkorange")) +
  geom_smooth()
```

## Delphinium

```{r checking Delphinium distribution}
delph.nbinom<-fitdist(delph$total.seeds, "nbinom") #fitting negative binomial distribution using fitdistplus package
plot(delph.nbinom) #plotting distribution fit
```

The Delphinium data fits a negative binomial distribution. We will use the glmmADMB package again.

```{r Delphinium glmmADMB}
delph.glmmadmb<-glmmadmb(total.seeds ~ relative.position + (1|site/plot.treat), family = "nbinom2", data = delph) #Delphinium model for negative binomial data with glmmadmb package
summary(delph.glmmadmb) #summary of model output
```

The plot treatment as a random effect and a separate fixed effect produced no significant results. The relative position was slightly significant.

Below is the same plot for the Delphinium individuals.

```{r Delphinium plot}
ggplot(delph, aes(x=delph$relative.position, y=delph$total.seeds, group=plot.treat)) +
  labs(title="Effect of Delphinium Blooming Time on Seed Set", y="Total Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkgreen","manip"="darkorange")) +
  geom_smooth()
```

## Potentilla

```{r checking Potentilla distribution}
pot.nbinom<-fitdist(pot$total.seeds, "nbinom") #fitting negative binomial distribution using fitdistplus package
plot(pot.nbinom) #plotting distribution fit
```

```{r Potentilla glmm}
pot.glmmadmb<-glmmadmb(total.seeds ~ relative.position + (1|site/plot.treat), family = "nbinom2", data = pot) #Potentilla model for negative binomial data with glmmadmb package
summary(pot.glmmadmb) #summary of model output
```

Both plot treatment and relative position significantly affected seed set in Potentilla individuals. Below is the plot for Potentilla individuals.

```{r Potentilla plot}
ggplot(pot, aes(x=pot$relative.position, y=pot$total.seeds, group=plot.treat)) +
  labs(title="Effect of Potentilla Blooming Time on Seed Set", y="Total Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkgreen","manip"="darkorange")) +
  geom_smooth()
```

# Mixed Effects Model with Proportion Data

Only the Mertensia and Delphinium data included proportion of developed seeds to total seeds. 

## Mertensia

```{r Mertensia undeveloped seeds}
mert$undev.seeds<-(mert$total.seeds-mert$dev.seed) #creating an undeveloped seed column for cbind
```

```{r Mertensia proportion model}
Mert.glmer<-glmer(cbind(dev.seed,undev.seeds) ~ relative.position + (1|site/plot.treat), family = binomial, data = mert) #Mertensia model with proportion of developed seeds using lme4 package
summary(Mert.glmer)
```

```{r Mertensia plot}
mert<-mert[!is.na(mert$prop.dev.seeds),] #removing NA values from proportion column

ggplot(mert, aes(x=mert$relative.position, y=mert$prop.dev.seeds, group=plot.treat)) +
  labs(y="Proportion of Developed Seeds",x="Relative Position in Population Phenology") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkgreen","manip"="darkorange")) +
  geom_smooth()
```

## Delphinium

```{r Delphinium proportion model}
delph$dev.seed.total<-delph$dev.seed+delph$dev.seed1 #creating developed seeds column
delph$undev.seed.total<-delph$undev.seed+delph$undev.seed1 #creating undeveloped seeds column

Delph.glmer<-glmer(cbind(dev.seed.total,undev.seed.total) ~ relative.position + (1|site/plot.treat), family = binomial, data = delph) #modeling Delphinium proportion of developed seeds with lme4 package
summary(Delph.glmer)
```

```{r Delphinium proportion plot}
delph<-delph[!is.na(delph$prop.dev.seeds),] #removing NA values in proportion column
ggplot(delph, aes(x=delph$relative.position, y=delph$prop.dev.seeds, group=plot.treat)) +
  labs(title="Effect of Delphinium Blooming Time on Seed Set", y="Proportion of Developed Seeds",x="Days Relative to Population Peak") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkgreen","manip"="darkorange")) + 
  geom_smooth()
```

# Mixed Effects Models: Effect of Soil Moisture Variables on Total Seeds

To understand which variables are most influential for seed production, we will run a generalized linear mixed model with all of the soil moisture variables. Site and plot treatment are random effects, while the soil moisture variables are fixed effects. The family is negative binomial because the data have a negative binomial distribution.

## Mertensia

```{r glmmADMB for soil moisture and Mertensia}
mert = read.csv("Mertensia_final2.csv") # read in Mertensia data
mert<-mert[!is.na(mert$total.seeds),] #removing NA values from Mertenia total seed column
mert.soil <- glmmadmb(total.seeds ~ mean+rate+effect.min+end+range+(1|site/plot.treat), family = "nbinom2", data = mert) #model to test effect of soil moisture variables on seeds using glmmADMB
summary(mert.soil)
```

## Delphinium

```{r glmmADMB for soil moisture and Delphinium}
delph = read.csv("Delphinium_final2.csv") # read in Delphinium data
delph<-delph[!is.na(delph$total.seeds),] #removing NA values from Delphinium total seed column
delph.soil <- glmmadmb(total.seeds ~ mean+rate+effect.min+end+range+(1|site/plot.treat), family = "nbinom2", data = delph) #model to test effect of soil moisture variables on seeds using glmmADMB
summary(delph.soil)
```

## Potentilla

```{r glmmADMB for soil moisture and Potentilla}
pot = read.csv("Potentilla_final2.csv") # read in Potentilla data
pot<-pot[!is.na(pot$total.seeds),] #removing NA values from Potentilla total seed column
pot.soil <- glmmadmb(total.seeds ~ mean+rate+effect.min+end+range+(1|site/plot.treat), family = "nbinom2", data = pot) #model to test effect of soil moisture variables on seeds using glmmADMB
summary(pot.soil)
```

# Mixed Effects Models: Effect of Soil Moisture Variables on Proportion of Seeds

## Mertensia

```{r glmmADMB for soil moisture and Mertensia proportions}
mert$prop.dev.seeds<-(mert$dev.seed/mert$total.seeds) #adding proportion of developed seeds
mert<-mert[!is.na(mert$prop.dev.seeds),] #removing NA values from proportion column

mert.prop.soil <- glmmadmb(prop.dev.seeds ~ mean+rate+effect.min+end+range+(1|site/plot.treat), family = "nbinom2", data = mert) #model to test effect of soil moisture variables on proportion of developed seeds using glmmADMB
summary(mert.prop.soil)
```

## Delphinium

```{r glmmADMB for soil moisture and Delphinium proportions}
delph$prop.dev.seeds<-(delph$total.seeds/(delph$undev.seed1+delph$undev.seed+delph$total.seeds)) #adding proportion of developed seeds
delph<-delph[!is.na(delph$prop.dev.seeds),] #removing NA values from proportion column

delph.prop.soil <- glmmadmb(prop.dev.seeds ~ mean+rate+effect.min+end+range+(1|site/plot.treat), family = "nbinom2", data = delph) #model to test effect of soil moisture variables on proportion of developed seeds using glmmADMB
summary(delph.prop.soil)
```

# Mixed Effects Models with Pollen Limitation Treatment

## Mertensia

```{r glmmADMB for mert pollen limitation}
mert.pollen.lim <- glmmadmb(total.seeds ~ treat + (1|site/plot.treat), family = "nbinom2", data = mert) #model to test effect of pollen limitation treatment on seeds using glmmADMB
summary(mert.pollen.lim)
```

## Delphinium

```{r glmmADMB for delph pollen limitation}
delph.pollen.lim <- glmmadmb(total.seeds ~ treat + (1|site/plot.treat), family = "nbinom2", data = delph) #model to test effect of pollen limitation treatment on seeds using glmmADMB
summary(delph.pollen.lim)
```

## Potentilla

```{r glmmADMB for pot pollen limitation}
pot<-pot[!is.na(pot$treat),] 
pot.pollen.lim <- glmmadmb(total.seeds ~ treat + (1|site/plot.treat), family = "nbinom2", data = pot) #model to test effect of pollen limitation treatment on seeds using glmmADMB
summary(pot.pollen.lim)
```

# Session Info

```{r Session Info}
sessionInfo()
```

