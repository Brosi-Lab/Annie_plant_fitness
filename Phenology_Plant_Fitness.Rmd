---
title: "Phenology and Plant Fitness"
author: "Annie Schiffer"
date: "started 27 January 2020; most recent edits `r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

This project aims to connect floral phenology to reproductive success on the individual level for three subalpine plants. Data were collected at the Rocky Mountain Biological Laboratory during the 2019 field season. Focal species include Mertensia fusiformis, Potentilla pulcherrima, and Delphinium nuttallianum. 

Our questions specifically ask: 
  1. how does blooming time affect seed set for individiuals in a population?
  2. how do abiotic factors such as soil moisture affect individual seed set?
  3. how do biotic factors such as conspecific density and pollen limitation affect individual seed set?
  
We tagged individuals of the three species in control and manipulated plots in eight sites across East River valley and Washington Gulch. We tracked blooming time of those tagged individuals and conducted a pollen limitation experiment with two treatments, open and pollen-supplemented. Seed set was quantified as the count of total developed seeds and proportion of developed seeds in each individual. 

Because there were sources of non-independence in this study, our statistical approach involves generalized linear mixed effects models. Our models includes site as a random effect and the following fixed effects: the interaction between being before or after the population peak and deviation from the peak and the interaction between conspecific density and plot treatment. A separate model included pollen limitation treatment.

# Load Packages

```{r clearing environment}
rm(list = ls()) #clearing environment
```

```{r packages}
suppressWarnings(suppressPackageStartupMessages(require(knitr)))
suppressWarnings(suppressPackageStartupMessages(require(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(require(lme4)))
suppressWarnings(suppressPackageStartupMessages(require(ggplot2)))
suppressWarnings(suppressPackageStartupMessages(require(RColorBrewer)))
suppressWarnings(suppressPackageStartupMessages(require(fitdistrplus)))
suppressWarnings(suppressPackageStartupMessages(require(glmmADMB)))
suppressWarnings(suppressPackageStartupMessages(require(MuMIn)))
suppressWarnings(suppressPackageStartupMessages(require(lubridate)))
suppressWarnings(suppressPackageStartupMessages(require(DHARMa)))
suppressWarnings(suppressPackageStartupMessages(require(glmmTMB)))
suppressWarnings(suppressPackageStartupMessages(require(dplyr)))
suppressWarnings(suppressPackageStartupMessages(require(stringr)))
suppressWarnings(suppressPackageStartupMessages(require(scales)))
suppressWarnings(suppressPackageStartupMessages(require(lmerTest)))
```

# Data Import & Basic Formatting

The imported csv files contain the following for each individual of a species: bloom start and end estimates, relative position of blooming in the community, soil moisture variables, and seed counts. These elements were compiled from five different data sets and calculated in a separate document. To view the data cleaning process, refer to the data cleaning R Markdown file, Data_Cleaning.Rmd. 

## Mertensia Data

The first dataset contains the individual data for Mertensia fusiformis, which was found in four of our sites. For Mertensia, we calculated the proportion of developed seeds in addition to the seed counts. We also reformatted the relative position as a deviation variable (the absolute value of the relative position) and a early/late variable (the direction of the relative position).

```{r Mertensia data import}
mert = read.csv("Mertensia_final2.csv") # read in Mertensia data
mert<-mert[!is.na(mert$relative.position),] #removing NA values from relative position column
mert<-mert[!is.na(mert$dev.seed),]
mert$prop.dev.seeds<-(mert$dev.seed/mert$total.seeds) #adding proportion of developed seeds
mert$deviation<-abs(mert$relative.position) #getting deviation from the peak
mert$early.late<-factor(NA, levels = c("early","late")) #creating early/late variables based on relative position
mert$early.late[mert$relative.position<0]<-"early"
mert$early.late[mert$relative.position>0]<-"late"
mert<-mert[!is.na(mert$early.late),]
```

## Delphinium Data

The second dataset contains individual data for Delphinium nuttallianum. Delphinium was found in four of our sites. For Delphinium, we calculated proportion, deviation, and early/late value like we did with the Mertensia data. 

```{r Delphinium data import}
delph = read.csv("Delphinium_final2.csv") # read in Delphinium data
delph<-delph[!is.na(delph$total.seeds),] #removing NA values in seed column
delph<-delph[!is.na(delph$relative.position),] #removing NA values in the relative position
delph$undev.seed1[is.na(delph$undev.seed1)] <- 0 #converting NA to 0
delph$prop.dev.seeds<-(delph$total.seeds/(delph$undev.seed1+delph$undev.seed+delph$total.seeds)) #adding proportion of developed seeds
delph$deviation<-abs(delph$relative.position) #getting deviation from the peak
delph$early.late<-factor(NA, levels = c("early","late")) #creating early/late variables based on relative position
delph$early.late[delph$relative.position<0]<-"early"
delph$early.late[delph$relative.position>0]<-"late"
delph<-delph[!is.na(delph$early.late),]
```

## Potentilla Data

The third dataset contains Potentilla pulcherrima data. Potentilla was set up in all but one of our sites. Potentilla data only includes total seed counts because we couldn't count the undeveloped seeds. However, we calculated the deviation and early/late values like the previous species.

```{r Potentilla data import}
pot = read.csv("Potentilla_final2.csv") # read in Potentilla data
pot<-pot[c(-119,-223),] #removing one row with NA in treatment column
pot<-pot[!is.na(pot$relative.position),] #removing NA values in relative position
pot<-pot[!is.na(pot$total.seeds),] #removing NA values in total seeds column
pot$deviation<-abs(pot$relative.position) #getting deviation from the peak
pot$early.late<-factor(NA, levels = c("early","late")) #creating early/late variables based on relative position
pot$early.late[pot$relative.position<0]<-"early"
pot$early.late[pot$relative.position>0]<-"late"
pot<-pot[!is.na(pot$early.late),]
```

Because many of the Potentilla individuals were still in bloom when we finished our field season, we had to calculate a midpoint and relative position based on those individuals that had senesced. A key factor that determines duration of blooming is the number of flowers on the individual. The data imported includes those relative position estimates for the individuals that didn't senesce before we finished our field season. For more information on how those numbers were calculated, see Data_Cleaning.Rmd.

## Flower Count Data

The community flower count data is essential to the number of conspecifics effect. Each of the species has to be analyzed separately.

```{r importing flower counts}
flower.counts=read.csv("flower_counts.csv") #read in flower count data
```

### Mertensia

We calculated the average number of Mertensia flowers in each site and plot in each week. This number was then merged with the Mertensia individuals to add the number of conspecifics variable.

```{r mert flower count manipulation}
mert.flower.counts<-flower.counts[(flower.counts$plant=="Mertensia fusiformis"),] #limit flower counts to Mertensia data
mert.counts.by.site<-aggregate(x=mert.flower.counts$total_flowers,by=list(mert.flower.counts$date,mert.flower.counts$site,mert.flower.counts$plot),FUN="mean") #calculate mean flower counts by week and site
colnames(mert.counts.by.site)<-c("date","site","plot.treat","number.conspecifics")
```

```{r merging to get mert conspecifics, results="hide"}
mert.counts.by.site$site<-as.character(mert.counts.by.site$site) #changing class to adjust names
mert.counts.by.site$plot.treat<-as.character(mert.counts.by.site$plot.treat)

mert.counts.by.site$site[mert.counts.by.site$site=="Avery Picnic"]<-"AveryPicnic" #fixing names
mert.counts.by.site$site[mert.counts.by.site$site=="Stupid Falls"]<-"StupidFalls"
mert.counts.by.site$site[mert.counts.by.site$site=="Wash 3C"]<-"WG3C"
mert.counts.by.site$plot.treat[!(mert.counts.by.site$plot.treat=="Kaysee")]
mert.counts.by.site$plot.treat[mert.counts.by.site$plot.treat=="Control"]<-"control"
mert.counts.by.site$plot.treat[mert.counts.by.site$plot.treat=="Manipulated"]<-"manip"

mert$week.estimate<-strftime(mert$midpoint, format = "%V") #calculating week numbers in preparation for the merge
mert.counts.by.site$week.estimate<-strftime(mert.counts.by.site$date, format = "%V")

mert<-merge(mert,mert.counts.by.site, by.x = c("site","plot.treat","week.estimate"), by.y = c("site","plot.treat","week.estimate")) #merging by site, plot treatment, and week estimate
```

### Delphinium

The same was repeated for Delphinium.

```{r delph flower count manipulation}
delph.flower.counts<-flower.counts[(flower.counts$plant=="Delphinium nuttallianum"),] #limit flower counts to Delphinium data
delph.counts.by.site<-aggregate(x=delph.flower.counts$total_flowers,by=list(delph.flower.counts$date,delph.flower.counts$site,delph.flower.counts$plot),FUN="mean") #calculate mean flower counts by week and site
colnames(delph.counts.by.site)<-c("date","site","plot.treat","number.conspecifics")
```

```{r merging to get delph conspecifics, results="hide"}
delph.counts.by.site$site<-as.character(delph.counts.by.site$site) #changing class to adjust names
delph.counts.by.site$plot.treat<-as.character(delph.counts.by.site$plot.treat)

delph.counts.by.site$site[delph.counts.by.site$site=="Rustlers Gulch"]<-"RustlersGulch" #fixing names
delph.counts.by.site$site[delph.counts.by.site$site=="Wash 3C"]<-"WG3C"
#delph.counts.by.site$plot.treat[!(delph.counts.by.site$plot.treat=="Kaysee")]
delph.counts.by.site$plot.treat[delph.counts.by.site$plot.treat=="Control"]<-"control"
delph.counts.by.site$plot.treat[delph.counts.by.site$plot.treat=="Manipulated"]<-"manip"

delph$week.estimate<-strftime(delph$midpoint, format = "%V") #calculating week numbers in preparation for the merge
delph.counts.by.site$week.estimate<-strftime(delph.counts.by.site$date, format = "%V")

delph<-merge(delph,delph.counts.by.site, by.x = c("site","plot.treat","week.estimate"), by.y = c("site","plot.treat","week.estimate")) #merging by site, plot treatment, and week estimate
```

### Potentilla

The same was done for Potentilla.

```{r pot flower count manipulation}
pot.flower.counts<-flower.counts[(flower.counts$plant=="Potentilla pulcherrima"),] #limit flower counts to Potentilla data
pot.counts.by.site<-aggregate(x=pot.flower.counts$total_flowers,by=list(pot.flower.counts$date,pot.flower.counts$site,pot.flower.counts$plot),FUN="mean") #calculate mean flower counts by week and site
colnames(pot.counts.by.site)<-c("date","site","plot.treat","number.conspecifics")
```

```{r merging to get pot conspecifics, results="hide"}
pot.counts.by.site$site<-as.character(pot.counts.by.site$site) #changing class to adjust names
pot.counts.by.site$plot.treat<-as.character(pot.counts.by.site$plot.treat)

pot.counts.by.site$site[pot.counts.by.site$site=="Rustlers Gulch"]<-"RustlersGulch" #fixing names
pot.counts.by.site$site[pot.counts.by.site$site=="Wash 3C"]<-"WG3C"
pot.counts.by.site$site[pot.counts.by.site$site=="Bellview Bench"]<-"BellviewBench"
pot.counts.by.site$site[pot.counts.by.site$site=="Avery Picnic"]<-"AveryPicnic"
pot.counts.by.site$site[pot.counts.by.site$site=="Stupid Falls"]<-"StupidFalls"
#pot.counts.by.site$plot.treat[!(pot.counts.by.site$plot.treat=="Kaysee")]
pot.counts.by.site$plot.treat[pot.counts.by.site$plot.treat=="Control"]<-"control"
pot.counts.by.site$plot.treat[pot.counts.by.site$plot.treat=="Manipulated"]<-"manip"

pot$week.estimate<-strftime(pot$midpoint, format = "%V") #calculating week numbers in preparation for the merge
pot.counts.by.site$week.estimate<-strftime(pot.counts.by.site$date, format = "%V")

pot<-merge(pot,pot.counts.by.site, by.x = c("site","plot.treat","week.estimate"), by.y = c("site","plot.treat","week.estimate")) #merging by site, plot treatment, and week estimate
```


# Mixed Effects Models: Effect of Soil Moisture Variables on Total Seeds

Soil moisture is a covariate that may impact seed production. In the field, we measured soil moisture in designated areas of the plot once per week, for 9 weeks. To understand which variables representing change in soil moisture are most influential for seed production, we ran a generalized linear mixed model with all of the soil moisture variables. Site, plot treatment, and species are random effects, while the soil moisture variables (mean moisture, rate of change, effective minimum or value at week 7, final moisture reading, and range) are fixed effects. Once we had this model, we ran the dredge function to find the most appropriate combination of variables for our larger model.

We are including all of the individuals of the three species and using species as a random effect.

```{r combining all of the seed data}
condensed.mert<-mert[,c(-4,-20,-21,-23,-24,-30)] #removing unnecessary columns
condensed.delph<-delph[,c(-4,-20:-28,-30,-36)]
condensed.pot<-pot[,c(-4,-20:-28,-30,-33:-37)]
names(condensed.mert)[names(condensed.mert)=="dev.seed"]<-"total.seeds"

condensed.mert<-condensed.mert[(condensed.mert$treat=="open"),] #limiting to open treatment
condensed.delph<-condensed.delph[(condensed.delph$treat=="open"),] 
condensed.pot<-condensed.pot[(condensed.pot$treat=="open"),] 

all.seeds<-rbind(condensed.mert,condensed.delph,condensed.pot) #combining all of the data sets
```

```{r checking distribution for all seed data}
all.seed.nbinom<-fitdist(all.seeds$total.seeds, "nbinom") #fitting Mertensia data to negative binomial distribution using fitdistplus
plot(all.seed.nbinom) #plotting to see the fit
```

The seeds fit a negative binomial distribution, so we used the glmmTMB package.

```{r soil model with glmmtmb, warning=FALSE}
soil.mod<-glmmTMB(total.seeds ~ mean + rate + effect.min + end + range + (1|site/plot.treat) + (1|species), family = "nbinom2", data = all.seeds) #model for soil moisture variables with all seeds
summary(soil.mod)
```

```{r model selection with dredge, message=FALSE}
dredge_result<-dredge(soil.mod) #using dredge function for model selection
subset(dredge_result, delta<4)
```
After running the model selection, we found that rate of soil moisture was the best model, but the null model was a very close second. The delta values between the rate of change predictor and the null model are 0.03 apart, which is very little. Even though the rate variable is not very different from the null model, we added the rate of change in our main models to incorporate the soil moisture covariate. 


# Mixed Effects Models with Count Data

Generalized linear mixed effects models were appropriate for this analysis because the data contain sources of non-independence. Individual plants were located in the same site as other individuals and were likely genetically similar. Therefore, we considered site a random effect. 

The response variable is total seeds, which is discrete and non-zero. The interaction between deviation and the early/late factor was a fixed effect, as well as the interaction between plot treatment and conspecific density. We would have included soil moisture as a covariate and fixed effect in our model, but soil moisture was not important for seed production. Each species is analyzed separately. 

## Mertensia

We started by limiting the individuals to the open treatment (excluding the hand-pollinated treatment) and by checking the distribution of the total seed counts.

```{r limiting Mertensia to open}
mert.open<-mert[(mert$treat=="open"),] #removed hand pollination treatment
```

```{r checking Mertensia distribution}
mert.nbinom<-fitdist(mert.open$dev.seed, "nbinom") #fitting Mertensia data to negative binomial distribution using fitdistplus
plot(mert.nbinom) #plotting to see the fit
```

The Mertensia seed data fits a negative binomial distribution. The glmmTMB package is a good package for modeling data with a negative binomial. The glmmTMB package is also suitable for data that could be overdispersed or zero-inflated.

```{r Mertensia glmmtmb with relative position, warning=FALSE}
#mert.glmmtmb<-glmmTMB(dev.seed ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), family = "nbinom2", data = mert.open) #putting count data into glmmTMB for DHARMa package
#summary(mert.glmmtmb) #summary of glmmTMB model
```
We did not detect an effect of relative blooming time, conspecific density, or plot treatment on the total number of seeds in Mertensia individuals. 

We then checked for overdispersion and zero-inflation in the data using the DHARMa package. The overdispersion and zero-inflation tests work with the glmmTMB package.

```{r checking mertensia counts overdispersion}
#mert.counts.simulation<-simulateResiduals(fittedModel = mert.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
#plot(mert.counts.simulation) #plotting simulation
#testDispersion(mert.counts.simulation) #checking for overdispersion
#testZeroInflation(mert.counts.simulation) #checking for zero inflation
```

The Mertensia count data is not overdispersed, but it is slightly zero-inflated. To address this, we adjusted our glmmtmb model to include zero-inflation.

```{r correcting mert counts glmmtmb}
mert.glmmtmb<-glmmTMB(dev.seed ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), ziformula=~1, family = "nbinom2", data = mert.open) #putting count data into glmmTMB for DHARMa package
summary(mert.glmmtmb) #summary of glmmTMB model
```
We then checked this new model for overdispersion and zero-inflation.

```{r checking new zi mert counts}
mert.counts.simulation<-simulateResiduals(fittedModel = mert.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.counts.simulation) #plotting simulation
testDispersion(mert.counts.simulation) #checking for overdispersion
testZeroInflation(mert.counts.simulation) #checking for zero inflation
```
Zero-inflation is accounted for in the new model, and the model for Mertensia count data is no longer zero-inflated.

To test the pollen limitation individuals, we created a separate fixed effects model. This model has site and plot treatment as random effects and pollen limitation treatment as a fixed effect. The response variable is still total number of developed seeds in Mertensia individuals.

```{r Mert glmmtmb pollen treat, warning=FALSE}
#mert.treat.glmmtmb<-glmmTMB(dev.seed ~ treat + (1|site/plot.treat), family = "nbinom2", data = mert) #Mertensia model for negative binomial data with glmmTMB package
#summary(mert.treat.glmmtmb) #summary of model output
```

We did not detect an effect of pollen limitation treatment on Mertensia total developed seeds.

We had to test the model assumptions of our pollen limitation model as well. After converting our model to an glmmTMB model, we tested for overdispersion and zero-inflation with the DHARMa package.

```{r checking mertensia counts pollen lim overdispersion}
#mert.counts.treat.simulation<-simulateResiduals(fittedModel = mert.treat.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
#plot(mert.counts.treat.simulation) #plotting simulation
#testDispersion(mert.counts.treat.simulation) #checking for overdispersion
#testZeroInflation(mert.counts.treat.simulation) #checking for zero inflation
```

The data in the pollen limitation model for Mertensia is not overdispersed, but it is zero-inflated. We then adjusted our model to include zero-inflation and ran the overdispersion and zero-inflation tests again.

```{r Mert new glmmtmb pollen treat, warning=FALSE}
mert.treat.glmmtmb<-glmmTMB(dev.seed ~ treat + (1|site/plot.treat), ziformula=~1, family = "nbinom2", data = mert) #Mertensia model for negative binomial data with glmmTMB package
summary(mert.treat.glmmtmb) #summary of model output
```

```{r mert checking zi count pollen treat, warning=FALSE}
mert.counts.treat.simulation<-simulateResiduals(fittedModel = mert.treat.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.counts.treat.simulation) #plotting simulation
testDispersion(mert.counts.treat.simulation) #checking for overdispersion
testZeroInflation(mert.counts.treat.simulation) #checking for zero inflation
```
The data are no longer zero-inflated, and we still did not detect an effect of pollen limitation on the Mertensia seed counts.

Below is the plot of seed set vs. relative position of blooming in the population for Mertensia individuals. Plot treatment is indicated by individual color.

```{r Mertensia plot, message=FALSE,warning=FALSE}
ggplot(mert.open, aes(x=mert.open$relative.position, y=mert.open$dev.seed, group=mert.open$plot.treat)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Mertensia Blooming Time on Total Developed Seeds") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r Mertensia linear plot, message=FALSE,warning=FALSE}
ggplot(mert.open, aes(x=mert.open$relative.position, y=mert.open$dev.seed, group=mert.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Mertensia Blooming Time on Total Developed Seeds") +
  theme_classic() +
  geom_point(aes(color=early.late),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  geom_smooth(method = "glm", aes(color=early.late))
```

We then plotted the interaction between deviation and early/late instead of relative position in order to fit a linear model.

```{r Mertensia plot substituting relative position, message=FALSE}
ggplot(mert.open, aes(x=mert.open$deviation, y=mert.open$dev.seed, group= mert.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Mertensia Deviation from Peak on Total Developed Seeds") + theme_classic() +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange"))
```

Then we plotted the effect of conspecific density and plot treatment on total developed seeds.

```{r Mertensia plot with conspecific density, message=FALSE}
ggplot(mert.open, aes(x=mert.open$number.conspecifics, y=mert.open$dev.seed, group= mert.open$plot.treat)) +
  labs(y="Total Developed Seeds",x="Conspecific Density", title="Effect of Mertensia Conspecific Density on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat)) +
  geom_smooth(method="glm",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue"))
```

Finally, we plotted all of the data with the pollinator active period. The pollinator active period was the time during which we saw interactions between pollinators and our species. The active period is shaded.

```{r Mertensia poll act plot, message=FALSE}
mert$midpoint2<-format(as.Date(mert$midpoint), format="%m-%d")

ggplot(mert, aes(x=mert$midpoint2, y=mert$dev.seed, group= mert$treat)) +
  labs(y="Total Developed Seeds",x="Date", title="Effect of Mertensia Blooming Time and Pollinator Activity on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin="06-19", xmax="07-03",ymin=0,ymax=Inf,alpha=0.1)
```


## Delphinium

For Delphinium, we again limited the individuals to open treatment individuals.

```{r limiting Delphinium to open}
delph.open<-delph[(delph$treat=="open"),] #removed hand pollination treatment
```

```{r checking Delphinium distribution}
delph.nbinom<-fitdist(delph.open$total.seeds, "nbinom") #fitting negative binomial distribution using fitdistplus package
plot(delph.nbinom) #plotting distribution fit
```

The Delphinium data fits a negative binomial distribution. We used the glmmTMB package again.

```{r Delphinium glmmTMB,warning=FALSE}
delph.glmmtmb<-glmmTMB(total.seeds ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), family = "nbinom2", data = delph.open) #Delphinium model for negative binomial data with glmmTMB package
#removed treat fixed effect (only open)
summary(delph.glmmtmb) #summary of model output
```
We did not detect an effect of relative blooming time, plot treatment, or conspecific density on the total developed seeds for Delphinium individuals.

Next, we tested the model assumptions as we did with Mertensia seed count data. We checked for overdispersion and zero-inflation.

```{r checking delphinium counts overdispersion}
delph.counts.simulation<-simulateResiduals(fittedModel = delph.glmmtmb) #creating simulation for Delphinium mixed effects model with DHARMa package
plot(delph.counts.simulation) #plotting simulation
testDispersion(delph.counts.simulation) #checking for overdispersion
testZeroInflation(delph.counts.simulation) #checking for zero inflation
```
The model for the Delphinium count data is not overdispersed or zero-inflated.

Again, we tested the pollen limitation in a separate mixed effects model. 

```{r Delph glmmtmb pollen treat,warning=FALSE}
#delph.treat.glmmtmb<-glmmTMB(total.seeds ~ treat + (1|site/plot.treat), family = "nbinom2", data = delph) #Mertensia model for negative binomial data with glmmTMB package
#summary(delph.treat.glmmtmb) #summary of model output
```
We did not detect an effect of pollen limitation on the total developed seeds of Delphinium individuals.

We again checked for overdispersion and zero-inflation in the pollen limitation data.

```{r checking delphinium counts pollen lim overdispersion}
#delph.counts.treat.simulation<-simulateResiduals(fittedModel = delph.treat.glmmtmb) #creating simulation for Delphinium mixed effects model with DHARMa package
#plot(delph.counts.treat.simulation) #plotting simulation
#testDispersion(delph.counts.treat.simulation) #checking for overdispersion
#testZeroInflation(delph.counts.treat.simulation) #checking for zero inflation
```
The Delphinum pollen limitation model is not overdispersed. The data are slightly zero-inflated. Because the data were zero-inflated, we adjusted our model to include the zero-inflation formula and re-tested the overdispersion and zero-inflation.

```{r Delph new glmmtmb pollen treat,warning=FALSE}
delph.treat.glmmtmb<-glmmTMB(total.seeds ~ treat + (1|site/plot.treat), ziformula=~1, family = "nbinom2", data = delph) #Mertensia model for negative binomial data with glmmTMB package
summary(delph.treat.glmmtmb) #summary of model output
```

```{r delph pollen lim treat check}
delph.counts.treat.simulation<-simulateResiduals(fittedModel = delph.treat.glmmtmb) #creating simulation for Delphinium mixed effects model with DHARMa package
plot(delph.counts.treat.simulation) #plotting simulation
testDispersion(delph.counts.treat.simulation) #checking for overdispersion
testZeroInflation(delph.counts.treat.simulation) #checking for zero inflation
```
The new model is not overdispersed or zero-inflated. We still did not see an effect of pollen limitation on the Delphinium count data.

Below are the plots for the Delphinium individuals.

```{r Delphinium plot,message=FALSE,warning=FALSE}
ggplot(delph.open, aes(x=delph.open$relative.position, y=delph.open$total.seeds, group=plot.treat)) +
  labs(title="Effect of Delphinium Blooming Time on Total Developed Seeds", y="Total Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r delph linear plot, message=FALSE,warning=FALSE}
ggplot(delph.open, aes(x=delph.open$relative.position, y=delph.open$total.seeds, group=delph.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Delphinium Blooming Time on Total Developed Seeds") +
  theme_classic() +
  geom_point(aes(color=early.late),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  geom_smooth(method = "glm", aes(color=early.late))
```

```{r delphinium plot substituting relative position,message=FALSE}
ggplot(delph.open, aes(x=delph.open$deviation, y=delph.open$total.seeds, group= delph.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Delphinium Deviation from Peak on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange"))
```


```{r Delphinium plot with conspecific density,message=FALSE}
ggplot(delph.open, aes(x=delph.open$number.conspecifics, y=delph.open$total.seeds, group= delph.open$plot.treat)) +
  labs(y="Total Developed Seeds",x="Conspecific Density", title="Effect of Delphinium Conspecific Density on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat)) +
  geom_smooth(method="glm",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue"))
```

Finally, we plotted the pollinator active period with the total number of developed seeds and midpoint of individuals.

```{r delph poll act plot, message=FALSE}
delph$midpoint2<-format(as.Date(delph$midpoint), format="%m-%d")

ggplot(delph, aes(x=delph$midpoint2, y=delph$total.seeds, group= delph$treat)) +
  labs(y="Total Developed Seeds",x="Date", title="Effect of Delphinium Blooming Time and Pollinator Activity on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin="06-27", xmax="07-18",ymin=0,ymax=Inf,alpha=0.1)
```

## Potentilla

We began by limiting the data to the open treatment Potentilla individuals.

```{r limiting Potentilla to open}
pot.open<-pot[(pot$treat=="open"),] #removed hand pollination treatment
```

```{r checking Potentilla distribution}
pot.nbinom<-fitdist(pot.open$total.seeds, "nbinom") #fitting negative binomial distribution using fitdistplus package
plot(pot.nbinom) #plotting distribution fit
```

The Potentilla seed data fits a negative binomial distribution. We used the glmmTMB package again.

```{r Potentilla glmmtmb,warning=FALSE}
#pot.glmmtmb<-glmmTMB(total.seeds ~ deviation * early.late + plot.treat * number.conspecifics + plot.treat + rate + (1|site), family = "nbinom2", data = pot.open) #Potentilla model for negative binomial data with glmmTMB package
#removed treat fixed effect (only open)
#summary(pot.glmmtmb) #summary of model output
```

We did not detect an effect of relative blooming time, plot treatment, or conspecific density on the total developed seeds of Potentilla individuals. However, the rate of change of soil moisture had an effect on seed set for Potentilla individuals. As rate of change increased, the total number of developed seeds decreased.

Below we checked overdispersion and zero-inflation.

```{r checking potentilla counts overdispersion}
#pot.counts.simulation<-simulateResiduals(fittedModel = pot.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
#plot(pot.counts.simulation) #plotting simulation
#testDispersion(pot.counts.simulation) #checking for overdispersion
#testZeroInflation(pot.counts.simulation) #checking for zero inflation
```
The Potentilla data are not overdispersed, but they are zero-inflated. To fix this, we had to include zero inflation in our model and again check for zero-inflation.

```{r Potentilla new glmmtmb,warning=FALSE}
pot.glmmtmb<-glmmTMB(total.seeds ~ deviation * early.late + plot.treat * number.conspecifics + plot.treat + rate + (1|site), ziformula=~1, family = "nbinom2", data = pot.open) #new Potentilla model for negative binomial data with glmmTMB package
summary(pot.glmmtmb) #summary of model output
```
When we incorporated zero-inflation into the model, we found a significant trend in the soil moisture variable. As the rate of change in soil moisture increases, the number of developed seeds in Potentilla individuals decreases. This was the same trend that we found in our previous model, but now the data are not overdispersed or zero-inflated. 

However, we had to test for overdispersion and zero-inflation again.

```{r checking new potentilla counts overdispersion}
pot.counts.simulation<-simulateResiduals(fittedModel = pot.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
plot(pot.counts.simulation) #plotting simulation
testDispersion(pot.counts.simulation) #checking for overdispersion
testZeroInflation(pot.counts.simulation) #checking for zero inflation
```
The data are no longer overdispersed or zero-inflated for the Potentilla count data.

Below is the mixed effects model for the pollen limitation treatments. 

```{r Pot glmmtmb pollen treat,warning=FALSE}
#pot.treat.glmmtmb<-glmmTMB(total.seeds ~ treat + (1|site/plot.treat), family = "nbinom2", data = pot) #Potentilla model for negative binomial data with glmmadmb package
#summary(pot.treat.glmmtmb) #summary of model output
```

We did not detect an effect of the pollen limitation treatment on the total number of developed seeds for Potentilla individuals.


Below is the test for overdispersion and zero-inflation for Potentilla pollen limitation data.

```{r checking potentilla counts pollen lim overdispersion}
#pot.counts.treat.simulation<-simulateResiduals(fittedModel = pot.treat.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
#plot(pot.counts.treat.simulation) #plotting simulation
#testDispersion(pot.counts.treat.simulation) #checking for overdispersion
#testZeroInflation(pot.counts.treat.simulation) #checking for zero inflation
```
The Potentilla pollen limitation data were not overdispersed, but they are zero-inflated. We addressed the zero-inflation issue by again including the zero-inflation formula into our models. 

```{r Pot new glmmtmb pollen treat,warning=FALSE}
pot.treat.glmmtmb<-glmmTMB(total.seeds ~ treat + (1|site/plot.treat), ziformula=~1, family = "nbinom2", data = pot) #Potentilla model for negative binomial data with glmmadmb package
summary(pot.treat.glmmtmb) #summary of model output
```

```{r checking new potentilla counts pollen lim overdispersion}
pot.counts.treat.simulation<-simulateResiduals(fittedModel = pot.treat.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
plot(pot.counts.treat.simulation) #plotting simulation
testDispersion(pot.counts.treat.simulation) #checking for overdispersion
testZeroInflation(pot.counts.treat.simulation) #checking for zero inflation
```
The data are no longer zero-inflated, and we still did not detect an effect of pollen limitation in the Potentilla individuals.


Below are the plots for Potentilla individuals.

```{r Potentilla plot,message=FALSE,warning=FALSE}
ggplot(pot.open, aes(x=pot.open$relative.position, y=pot.open$total.seeds, group=plot.treat)) +
  labs(title="Effect of Potentilla Blooming Time on Total Developed Seeds", y="Total Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r pot linear plot, message=FALSE,warning=FALSE}
ggplot(pot.open, aes(x=pot.open$relative.position, y=pot.open$total.seeds, group=pot.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Potentilla Blooming Time on Total Developed Seeds") +
  theme_classic() +
  geom_point(aes(color=early.late),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  geom_smooth(method = "glm", aes(color=early.late))
```

```{r potentilla plot substituting relative position,message=FALSE}
ggplot(pot.open, aes(x=pot.open$deviation, y=pot.open$total.seeds, group= pot.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom",title="Effect of Potentilla Deviation from Peak on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange"))
```

```{r Potentilla plot with conspecific density,message=FALSE}
ggplot(pot.open, aes(x=pot.open$number.conspecifics, y=pot.open$total.seeds, group= pot.open$plot.treat)) +
  labs(y="Total Developed Seeds",x="Conspecific Density", title="Effect of Potentilla Conspecific Density on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat)) +
  geom_smooth(method="glm",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue"))
```

Again we plotted the pollinator activity period.

```{r pot poll act plot, message=FALSE}
ggplot(pot,aes(x=as.Date.factor(pot$midpoint), y=pot$total.seeds, group= pot$treat)) +
  labs(y="Total Developed Seeds",x="Date", title="Pollinator Activity Period and Total Developed Seeds in Potentilla") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin=as.Date.character("2019-07-05"), xmax=as.Date.character("2019-08-24"),ymin=0,ymax=Inf,alpha=0.1) +
  scale_x_date(date_breaks = "3 days", date_labels = "%m/%d")
```

# Mixed Effects Model with Proportion Data

Only the Mertensia and Delphinium data included proportion of developed seeds to total seeds. When counting seeds for the Potentilla individuals, undeveloped seeds were difficult to distinguish from other elements of the carpel and were not included. Because the data are proportions and we are using the cbind function, we assume a binomial distribution. 

## Mertensia

First, we had to calculate undeveloped seeds to use the cbind function for our proportion of developed seeds.

```{r Mertensia undeveloped seeds}
mert.open$undev.seeds<-(mert.open$total.seeds-mert.open$dev.seed) #creating an undeveloped seed column for cbind
```

Below is the mixed effects model for the proportion of developed seeds. The individuals are still only limited to the open treatment. 

```{r Mertensia proportion model,warning=FALSE}
Mert.prop.glmmtmb<-glmmTMB(cbind(dev.seed,undev.seeds) ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), family = binomial, data = mert.open) #Mertensia model with proportion of developed seeds using the glmmTMB package
#removed treat fixed effect (only open in data set)
summary(Mert.prop.glmmtmb)
```

A significant effect was detected in the number of conspecifics and the rate of change in soil moisture. As the number of conspecifics increased, the proportion of developed seeds in Mertensia individuals decreased. For the soil moisture variable, as the rate of change in soil moisture increased, the proportion of developed seeds decreased. 

Once we had our model, we were able to check for overdispersion and zero inflaction. We checked for overdispersion and zero inflation with the DHARMa package.

```{r checking Mert overdispersion}
mert.prop.simulation<-simulateResiduals(fittedModel = Mert.prop.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.prop.simulation) #plotting simulation
testDispersion(mert.prop.simulation) #checking for overdispersion
testZeroInflation(mert.prop.simulation)
```
The Mertensia proportion data were not overdispersed or zero-inflated.

Next, we created the pollen limitation model for the Mertensia developed seeds. The model includes site and plot treatment as random effects like the models above. Now the proportion of developed seeds is the response variable.

```{r Mert prop pollen treat,warning=FALSE}
mert$undev.seeds<-(mert$total.seeds-mert$dev.seed) #creating an undeveloped seed column for cbind

Mert.prop.treat.glmmtmb<-glmmTMB(cbind(dev.seed,undev.seeds) ~ treat + (1|site/plot.treat), family = binomial, data = mert) #model with pollen lim treatment and proportion of developed seeds using the glmmTMB package
summary(Mert.prop.treat.glmmtmb) #summary of model results
```
We did not detect an effect of pollen supplementation on the proportions of developed seeds for Mertensia individuals.

We again checked to see if the data were overdispersed.

```{r checking Mert pollen lim overdispersion}
mert.prop.treat.simulation<-simulateResiduals(fittedModel = Mert.prop.treat.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.prop.treat.simulation) #plotting simulation
testDispersion(mert.prop.treat.simulation) #checking for overdispersion
testZeroInflation(mert.prop.treat.simulation) #checking for zero inflation
```
Our pollen limitation model for Mertensia proportions was not overdispersed or zero-inflated.


Below are the plots for Mertensia proportion data.

```{r Mertensia proportion plot,message=FALSE,warning=FALSE}
mert.open<-mert.open[!is.na(mert.open$prop.dev.seeds),] #removing NA values from proportion column

ggplot(mert.open, aes(x=mert.open$relative.position, y=mert.open$prop.dev.seeds, group=plot.treat)) +
  labs(y="Proportion of Developed Seeds",x="Days Relative to Population Peak Bloom",title="Effect of Mertensia Blooming Time on Proportion of Developed Seeds") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r Mertensia deviation proportion plot,message=FALSE}
ggplot(mert.open, aes(x=mert.open$deviation, y=mert.open$prop.dev.seeds, group= mert.open$early.late)) +
  labs(y="Proportion of Developed Seeds",x="Days Relative to Population Peak Bloom",title="Effect of Mertensia Deviation from Peak on Proportion of Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange"))
```

Despite a marginally significant interaction effect, the effect of deviation on early vs. late individuals was not strong for Mertensia proportions of developed seeds.

```{r mertensia plot conspecifics and proportions,message=FALSE}
ggplot(mert.open, aes(x=mert.open$number.conspecifics, y=mert.open$prop.dev.seeds, group= mert.open$plot.treat)) +
  labs(y="Proportion of Developed Seeds",x="Conspecific Density",title="Effect of Mertensia Conspecific Density on Proportion of Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat)) +
  geom_smooth(method="glm",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue"))
```

Finally, we added pollinator activity.

```{r Mertensia prop poll act plot, message=FALSE, warning=FALSE}
ggplot(mert, aes(x=as.Date.factor(mert$midpoint), y=mert$prop.dev.seeds, group= mert$treat)) +
  labs(y="Proportion of Developed Seeds",x="Date", title="Pollinator Activity Period and Proportion of Developed Seeds in Mertensia") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin=as.Date.character("2019-06-19"), xmax=as.Date.character("2019-07-03"),ymin=0,ymax=Inf,alpha=0.1) +
  scale_x_date(date_breaks = "3 days", date_labels = "%m/%d")
```

## Delphinium

We had to find the total developed seeds and undeveloped seeds before creating the model. To do this, we combined the seed counts of the first flower in bloom with the rest of the flowers on the plant.

```{r Delphinium proportion model,warning=FALSE, message=FALSE}
delph.open$dev.seed.total<-delph.open$dev.seed+delph.open$dev.seed1 #creating developed seeds column
delph.open$undev.seed.total<-delph.open$undev.seed+delph.open$undev.seed1 #creating undeveloped seeds column
```

```{r delphinium proportion model, warning=FALSE,message=FALSE}
#Delph.prop.glmmtmb<-glmmTMB(cbind(dev.seed.total,undev.seed.total) ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), family = binomial, data = delph.open) #modeling Delphinium proportion of developed seeds with glmmTMB package
#removed treat fixed effect (only open)
#summary(Delph.prop.glmmtmb)
```
Our model shows that relative position, plot treatment, and number of conspecifics had an effect on seed set. We see a marginally significant trend that late individuals have lower seed set than early individuals. The manipulated individuals had significantly higher seed set than the control individuals. Also, there was a significant interaction between number of conspecifics and plot treatment.

We again tested for overdispersion and zero inflation. We used the DHARMa package for the Delphinium proportion data.

```{r checking delph prop overdispersion}
#delph.prop.simulation<-simulateResiduals(fittedModel = Delph.prop.glmmtmb) #creating simulation for Delphinium model
#plot(delph.prop.simulation) #plotting simulation
#testDispersion(delph.prop.simulation) #checking for overdispersion
#testZeroInflation(delph.prop.simulation) #checking for zero inflation
```
Our Delphinium proportion data is overdispersed and zero-inflated. We adjusted our model to correct for these issues. To fix overdispersion, we are using a betabinomial family, and we added a zero-inflation formula to correct zero-inflation.

```{r new delph model, warning=FALSE, message=FALSE}
Delph.prop.glmmtmb<-glmmTMB(cbind(dev.seed.total,undev.seed.total) ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), ziformula=~1, family = betabinomial, data = delph.open) #modeling Delphinium proportion of developed seeds with betabinomial family and ziformula
summary(Delph.prop.glmmtmb) #summary of model output
```
After correcting for overdispersion and zero-inflation, we did not detect an effect of relative blooming time, conspecific density, or plot treatment on the proportion of developed seeds for Delphinium individuals.

We again checked for overdispersion and zero-inflation in the new model.

```{r checking new delph overdispersion}
delph.prop.simulation<-simulateResiduals(fittedModel = Delph.prop.glmmtmb) #creating simulation for Delphinium model
plot(delph.prop.simulation) #plotting simulation
testDispersion(delph.prop.simulation) #checking for overdispersion
testZeroInflation(delph.prop.simulation) #checking for zero inflation
```
The data are no longer overdispersed or zero-inflated.

We created the mixed effects model for the pollen supplemented Delphinium individuals. Like the Mertensia model above, site and plot treatment are random effects, pollen limitation treatment is the fixed effect, and proportion of developed seeds is the response variable.

```{r delph prop pollen lim,warning=FALSE}
delph$dev.seed.total<-delph$dev.seed+delph$dev.seed1 #creating developed seeds column
delph$undev.seed.total<-delph$undev.seed+delph$undev.seed1 #creating undeveloped seeds column
```

```{r delph prop pollen lim model, warning=FALSE}
#Delph.prop.treat.glmmtmb<-glmmTMB(cbind(dev.seed.total,undev.seed.total) ~ treat + (1|site/plot.treat), family = binomial, data = delph) #modeling pollen lim and proportion of developed seeds with glmmTMB package
#summary(Delph.prop.treat.glmmtmb) #model summary
```

Delphinium proportions of developed seeds were significantly affected by pollen supplementation. Pollen supplementation significantly increased the proportion of developed seeds.

Below are our simulations for checking overdispersion and zero-inflation.

```{r checking delph pollen lim overdispersion}
#delph.prop.treat.simulation<-simulateResiduals(fittedModel = Delph.prop.treat.glmmtmb) #creating simulation for Delphinium model
#plot(delph.prop.treat.simulation) #plotting simulation
#testDispersion(delph.prop.treat.simulation) #checking for overdispersion
#testZeroInflation(delph.prop.treat.simulation) #checking for zero inflation
```
The pollen limitation model for Delphinium proportion data is overdispersed and zero-inflated. As with the model above, we changed the family to beta binomial and included the zero-inflation formula.

```{r new prop pollen lim model}
Delph.prop.treat.glmmtmb<-glmmTMB(cbind(dev.seed.total,undev.seed.total) ~ treat + (1|site/plot.treat), ziformula=~1, family = betabinomial, data = delph) #modeling pollen lim and proportion of developed seeds with glmmTMB
summary(Delph.prop.treat.glmmtmb) #model summary
```
After correcting the model, we did not detect an effect of pollen limitation on the proportion of developed seeds for Delphinium individuals. Again we checked for overdispersion and zero-inflation.

```{r checking new delph pollen lim overdispersion}
delph.prop.treat.simulation<-simulateResiduals(fittedModel = Delph.prop.treat.glmmtmb) #creating simulation for Delphinium model
plot(delph.prop.treat.simulation) #plotting simulation
testDispersion(delph.prop.treat.simulation) #checking for overdispersion
testZeroInflation(delph.prop.treat.simulation) #checking for zero inflation
```
The data are no longer overdispersed or zero-inflated. 

Below are the plots for the proportion of developed seeds in Delphinium individuals.

```{r Delphinium proportion plot,message=FALSE,warning=FALSE}
delph.open<-delph.open[!is.na(delph.open$prop.dev.seeds),] #removing NA values in proportion column
ggplot(delph.open, aes(x=delph.open$relative.position, y=delph.open$prop.dev.seeds, group=plot.treat)) +
  labs(title="Effect of Delphinium Blooming Time on Proportion of Developed Seeds", y="Proportion of Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r Delphinium deviation proportion plot,message=FALSE}
ggplot(delph.open, aes(x=delph.open$deviation, y=delph.open$prop.dev.seeds, group= delph.open$early.late)) +
  labs(y="Proportion of Developed Seeds",x="Days Relative to Population Peak Bloom",title="Effect of Delphinium Deviation from Peak on Proportion of Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange"))
```

```{r Delphinium plot conspecifics and proportions,message=FALSE}
ggplot(delph.open, aes(x=delph.open$number.conspecifics, y=delph.open$prop.dev.seeds, group= delph.open$plot.treat)) +
  labs(y="Proportion of Developed Seeds",x="Conspecific Density",title="Effect of Delphinium Conspecific Density on Proportion of Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat)) +
  geom_smooth(method="glm",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue")) + xlim(0,110)
```

Finally, we added pollinator activity.

```{r delph poll act prop plot, message=FALSE, warning=FALSE}
ggplot(delph, aes(x=as.Date.factor(delph$midpoint), y=delph$prop.dev.seeds, group= delph$treat)) +
  labs(y="Proportion of Developed Seeds",x="Date", title="Pollinator Activity Period and Proportion of Developed Seeds in Delphinium") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin=as.Date.character("2019-06-27"), xmax=as.Date.character("2019-07-18"),ymin=0,ymax=Inf,alpha=0.1) +
  scale_x_date(date_breaks = "3 days", date_labels = "%m/%d")
```

# Mixed Effects Models with Seed Weights

In addition to counting the number of developed seeds and undeveloped seeds, we weighed the developed seeds for individuals of our three focal species. Seed weights were measured in grams. Several individuals did not produce any developed seeds, and we recorded these weights as zero. 

## Mertensia

First, we had to convert the weights from grams to mg and eliminate the zeros by changing all zeros to 0.0001. 

```{r changing mert seed weights to mg, message=FALSE, warning=FALSE}
mert.open$seed.weight<-mert.open$seed.weight*1000 #converting seed weights to mg
mert.open$seed.weight[mert.open$seed.weight=="0"] <- "0.0001" #eliminating zeros in data set
mert.open$seed.weight<-as.numeric(mert.open$seed.weight) #changing to numeric
```

We then checked the distribution. Because weight is a continuous variable, the data fit a gaussian distribution.

```{r checking mert weight seed distribution, message=FALSE, warning=FALSE}
mert.gaus<-fitdist(mert.open$seed.weight, "norm") #fitting Mertensia data to normal distribution using fitdistplus
plot(mert.gaus) #plotting to see the fit
```

With normally distributed data, the best model to use is the lmer function from the lmerTest package. The lme4 package also has the lmer function, but it doesn't produce p-values in the results. The fixed and random effects are the same from the seed count and proportion models. 

```{r Mertensia seed weight model, message=FALSE, warning=FALSE}
mert.lmer<-lmer(seed.weight ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), data = mert.open) #Mertensia model with seed weights using the lmerTest package
summary(mert.lmer)
```
We did not detect an effect of relative flowering time, conspecific density, or soil moisture on the seed weights for Mertensia individuals.

```{r checking mert seed weights overdispersion, message=FALSE, warning=FALSE}
mert.weights.simulation<-simulateResiduals(fittedModel = mert.lmer) #creating simulation for Mertenisa glmer model
plot(mert.weights.simulation) #plotting simulation
testDispersion(mert.weights.simulation) #checking for overdispersion
testZeroInflation(mert.weights.simulation) #checking for zero inflation
```

The data are not overdispersed or zero-inflated.

Next, we tested the effect of pollen limitation treatment. We again used the lmer function and the same fixed and random effects.

```{r changing mert weights pollen treat, message=FALSE, warning=FALSE}
mert$seed.weight<-mert$seed.weight*1000
mert$seed.weight[mert$seed.weight=="0"] <- "0.0001" #eliminating zeros in data set
mert$seed.weight<-as.numeric(mert$seed.weight) #changing to numeric
```

```{r mert pollen lim seed weights, message=FALSE, warning=FALSE}
mert.treat.lmer<-lmer(seed.weight ~ treat + (1|site/plot.treat), data = mert) #Mertensia model for seed weight data and pollen lim treatment with lme4 package
summary(mert.treat.lmer) #summary of model output
```
We did not detect an effect of pollen supplementation on the seed weights of Mertensia individuals. We checked for overdispersion and zero-inflation again.

```{r checking mert seed weights pol lim overdispersion, message=FALSE, warning=FALSE}
mert.treat.weights.simulation<-simulateResiduals(fittedModel = mert.treat.lmer) #creating simulation for Mertenisa glmer model
plot(mert.treat.weights.simulation) #plotting simulation
testDispersion(mert.treat.weights.simulation) #checking for overdispersion
testZeroInflation(mert.treat.weights.simulation) #checking for zero inflation
```
The data are not overdispersed or zero-inflated.

## Delphinium

```{r changing delph seed weights to mg, message=FALSE, warning=FALSE}
delph.open$seed.weight<-delph.open$weight1 + delph.open$weight.rest #combining weight of first flower seeds and the rest of the seeds
delph.open$seed.weight<-delph.open$seed.weight*1000 #converting seed weights to mg
delph.open$seed.weight[delph.open$seed.weight=="0"] <- "0.0001" #eliminating zeros in data set
delph.open$seed.weight<-as.numeric(delph.open$seed.weight) #changing to numeric
```

We checked the distribution. Because weight is a continuous variable, the data fit a gaussian distribution.

```{r checking delph weight seed distribution, message=FALSE, warning=FALSE}
delph.gaus<-fitdist(delph.open$seed.weight, "norm") #fitting Mertensia data to normal distribution using fitdistplus
plot(delph.gaus) #plotting to see the fit
```

Below is the model using seed weight for Delphinium individuals. The fixed and random effects are the same as the previous Delphinium models. We again used the lmerTest package.

```{r delph seed weight model, message=FALSE, warning=FALSE}
delph.lmer<-lmer(seed.weight ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), data = delph.open) #Delphinium model with seed weights using the lmerTest package
summary(delph.lmer)
```
Seeds from individuals in the accelerated snowmelt plot were heavier than seeds from individuals in the control plot. Additionally, there is a marginally significant negative effect of soil moisture rate of change on seed weight. We did not detect an effect of conspecific density on the seed weights of Delphinium individuals.

```{r checking delph seed weights overdispersion, message=FALSE, warning=FALSE}
delph.weights.simulation<-simulateResiduals(fittedModel = delph.lmer) #creating simulation for Delphinium glmer model
plot(delph.weights.simulation) #plotting simulation
testDispersion(delph.weights.simulation) #checking for overdispersion
testZeroInflation(delph.weights.simulation) #checking for zero inflation
```
The data are not overdispersed or zero-inflated. 

Next, we again tested for the effect of pollen limitation treatment on seed weight.

```{r changing delph weights pollen treat, message=FALSE, warning=FALSE}
delph$seed.weight<-delph$weight1 + delph$weight.rest #combining weight of first flower seeds and the rest of the seeds
delph$seed.weight<-delph$seed.weight*1000
delph$seed.weight[delph$seed.weight=="0"] <- "0.0001" #eliminating zeros in data set
delph$seed.weight<-as.numeric(delph$seed.weight) #changing to numeric
```

```{r delph pollen lim seed weights, message=FALSE, warning=FALSE}
delph.treat.lmer<-lmer(seed.weight ~ treat + (1|site/plot.treat), data = delph) #Delphinium model for seed weight data and pollen lim treatment with lme4 package
summary(delph.treat.lmer) #summary of model output
```
We did not detect an effect of pollen supplementation on the seed weights of Delphinium individuals. We checked for overdispersion and zero-inflation again.

```{r checking delph seed weights pol lim overdispersion, message=FALSE, warning=FALSE}
delph.treat.weights.simulation<-simulateResiduals(fittedModel = delph.treat.lmer) #creating simulation for Delphinium glmer model
plot(delph.treat.weights.simulation) #plotting simulation
testDispersion(delph.treat.weights.simulation) #checking for overdispersion
testZeroInflation(delph.treat.weights.simulation) #checking for zero inflation
```
The data are not overdispersed or zero-inflated.

## Potentilla

```{r changing pot seed weights to mg, message=FALSE, warning=FALSE}
pot.open$total.seed.weight<-pot.open$total.seed.weight*1000 #converting seed weights to mg
pot.open$total.seed.weight[pot.open$total.seed.weight=="0"] <- "0.0001" #eliminating zeros in data set
pot.open$total.seed.weight<-as.numeric(pot.open$total.seed.weight) #changing to numeric
```

We then checked the distribution. Because weight is a continuous variable, the data fit a gaussian distribution.

```{r checking pot weight seed distribution, message=FALSE, warning=FALSE}
pot.gaus<-fitdist(pot.open$total.seed.weight, "norm") #fitting Potentilla data to normal distribution using fitdistplus
plot(pot.gaus) #plotting to see the fit
```

Below is the model for the seed weights of Potentilla individuals. The fixed and random effects are the same from the seed count and proportion models. 

```{r Pot seed weight model, message=FALSE, warning=FALSE}
pot.lmer<-lmer(total.seed.weight ~ deviation * early.late + plot.treat * number.conspecifics + rate + (1|site), data = pot.open) #Potentilla model with seed weights using the lmerTest package
summary(pot.lmer)
```
We did not detect an effect of relative flowering time, conspecific density, or soil moisture on the seed weights for Potentilla individuals.

```{r checking pot seed weights overdispersion, message=FALSE, warning=FALSE}
pot.weights.simulation<-simulateResiduals(fittedModel = pot.lmer) #creating simulation for Potentilla glmer model
plot(pot.weights.simulation) #plotting simulation
testDispersion(pot.weights.simulation) #checking for overdispersion
testZeroInflation(pot.weights.simulation) #checking for zero inflation
```
The data are not overdispersed or zero-inflated.

Next, we tested the effect of pollen limitation treatment. We again used the lmer function and the same fixed and random effects.

```{r pot weights pollen treat, message=FALSE, warning=FALSE}
pot$total.seed.weight<-pot$total.seed.weight*1000
pot$total.seed.weight[pot$total.seed.weight=="0"] <- "0.0001" #eliminating zeros in data set
pot$total.seed.weight<-as.numeric(pot$total.seed.weight) #changing to numeric
```

```{r pot pollen lim seed weights, message=FALSE, warning=FALSE}
pot.treat.lmer<-lmer(total.seed.weight ~ treat + (1|site/plot.treat), data = pot) #Potentilla model for seed weight data and pollen lim treatment with lme4 package
summary(pot.treat.lmer) #summary of model output
```
We did not detect an effect of pollen supplementation on the seed weights of Potentilla individuals. We checked for overdispersion and zero-inflation again.

```{r checking pot seed weights pol lim overdispersion, message=FALSE, warning=FALSE}
pot.treat.weights.simulation<-simulateResiduals(fittedModel = pot.treat.lmer) #creating simulation for Potentilla glmer model
plot(pot.treat.weights.simulation) #plotting simulation
testDispersion(pot.treat.weights.simulation) #checking for overdispersion
testZeroInflation(pot.treat.weights.simulation) #checking for zero inflation
```
The data are not overdispersed or zero-inflated.

# Session Info

```{r Session Info}
sessionInfo()
```

