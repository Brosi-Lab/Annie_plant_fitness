---
title: "Phenology and Plant Fitness"
author: "Annie Schiffer"
date: "started 27 January 2020; most recent edits `r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

This project aims to connect floral phenology to reproductive success on the individual level for three subalpine plants. Data were collected at the Rocky Mountain Biological Laboratory during the 2019 field season. Focal species include Mertensia fusiformis, Potentilla pulcherrima, and Delphinium nuttallianum. 

Our questions specifically ask: 
  1. how does blooming time affect seed set for individiuals in a population?
  2. how do biotic factors such as conspecific density and pollen limitation affect individual seed set?
  
We tagged individuals of the three species in control and manipulated plots in eight sites across East River valley and Washington Gulch. We tracked blooming time of those tagged individuals and conducted a pollen limitation experiment with two treatments, open and pollen-supplemented. Seed set was quantified as the count of total developed seeds and proportion of developed seeds in each individual. 

Because there were sources of non-independence in this study, our statistical approach involves generalized linear mixed effects models. Our models include site as a random effect and the following fixed effects: the interaction between being before or after the population peak and deviation from the peak, and the interaction between conspecific density and plot treatment. A separate model included pollen limitation treatment.

# Load Packages

```{r clearing environment}
rm(list = ls()) #clearing environment
```

```{r packages}
suppressWarnings(suppressPackageStartupMessages(require(knitr)))
suppressWarnings(suppressPackageStartupMessages(require(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(require(lme4)))
suppressWarnings(suppressPackageStartupMessages(require(ggplot2)))
suppressWarnings(suppressPackageStartupMessages(require(RColorBrewer)))
suppressWarnings(suppressPackageStartupMessages(require(fitdistrplus)))
suppressWarnings(suppressPackageStartupMessages(require(glmmADMB)))
suppressWarnings(suppressPackageStartupMessages(require(MuMIn)))
suppressWarnings(suppressPackageStartupMessages(require(lubridate)))
suppressWarnings(suppressPackageStartupMessages(require(DHARMa)))
suppressWarnings(suppressPackageStartupMessages(require(glmmTMB)))
suppressWarnings(suppressPackageStartupMessages(require(dplyr)))
suppressWarnings(suppressPackageStartupMessages(require(stringr)))
suppressWarnings(suppressPackageStartupMessages(require(scales)))
suppressWarnings(suppressPackageStartupMessages(require(lmerTest)))
```

# Data Import & Basic Formatting

The imported csv files contain the following for each individual of a species: bloom start and end estimates, relative position of blooming in the community, soil moisture variables, and seed counts. These elements were compiled from five different data sets and calculated in a separate document. To view the data cleaning process, refer to the data cleaning R Markdown file, Data_Cleaning.Rmd. 

## Mertensia Data (new midpoints!)

The first dataset contains the individual data for Mertensia fusiformis, which was found in four of our sites. For Mertensia, we calculated the proportion of developed seeds in addition to the seed counts. We also reformatted the relative position as a deviation variable (the absolute value of the relative position) and a early/late variable (the direction of the relative position).

```{r Mertensia data import}
mert = read.csv("Mertensia_final3.csv") # read in Mertensia data
mert$prop.dev.seeds<-(mert$dev.seed/mert$total.seeds) #adding proportion of developed seeds
mert$deviation<-abs(mert$relative.position) #getting deviation from the peak

#creating early/late variables based on relative position
mert$early.late<-factor(NA, levels = c("early","late"))
mert$early.late[mert$relative.position<0]<-"early"
mert$early.late[mert$relative.position>0]<-"late"
mert<-mert[!is.na(mert$early.late),]

#removing NAs
mert<-mert[!is.na(mert$dev.seed),] 
mert$prop.dev.seeds[is.na(mert$prop.dev.seeds)] <-0
```

## Delphinium Data

The second dataset contains individual data for Delphinium nuttallianum. Delphinium was found in four of our sites. For Delphinium, we calculated proportion, deviation, and early/late value like we did with the Mertensia data. 

```{r Delphinium data import}
delph = read.csv("Delphinium_final2.csv") # read in Delphinium data
delph$undev.seed1[is.na(delph$undev.seed1)] <- 0 #converting NA to 0
delph$dev.seed.total<-delph$dev.seed+delph$dev.seed1 #creating developed seeds column
delph$undev.seed.total<-delph$undev.seed+delph$undev.seed1 #creating undeveloped seeds column
delph$prop.dev.seeds<-(delph$dev.seed.total/(delph$dev.seed.total+delph$undev.seed.total)) #adding proportion of developed seeds

delph$deviation<-abs(delph$relative.position) #getting deviation from the peak

#creating early/late variables based on relative position
delph$early.late<-factor(NA, levels = c("early","late")) 
delph$early.late[delph$relative.position<0]<-"early"
delph$early.late[delph$relative.position>0]<-"late"
delph<-delph[!is.na(delph$early.late),]

#removing NAs
delph<-delph[!is.na(delph$dev.seed.total),]
delph$prop.dev.seeds[is.na(delph$prop.dev.seeds)] <-0
```

## Potentilla Data

The third dataset contains Potentilla pulcherrima data. Potentilla was set up in all but one of our sites. Potentilla data only includes total seed counts because it was difficult to distinguish the undeveloped seeds from other elements of the carpel. However, we calculated the deviation and early/late values like the previous species.

```{r Potentilla data import}
pot = read.csv("Potentilla_final2.csv") # read in Potentilla data
pot$deviation<-abs(pot$relative.position) #getting deviation from the peak

#creating early/late variables based on relative position
pot$early.late<-factor(NA, levels = c("early","late")) 
pot$early.late[pot$relative.position<0]<-"early"
pot$early.late[pot$relative.position>0]<-"late"

#removing NAs
pot<-pot[!is.na(pot$early.late),] 
```

A note about the Potentilla data: 

Because many of the Potentilla individuals were still in bloom when we finished our field season, we had to calculate a midpoint and relative position based on those individuals that had senesced. A key factor that determines duration of blooming is the number of flowers on the individual. The data imported includes those relative position estimates for the individuals that didn't senesce before we finished our field season. For more information on how those numbers were calculated, see Data_Cleaning.Rmd.

## Flower Count Data

The community flower count data is essential to the conspecific density variable and population peak metric. Each of the species has to be analyzed separately.

```{r importing flower counts}
flower.counts=read.csv("./Raw_data/flower_counts.csv") #read in flower count data
```

### Mertensia

We calculated the average number of Mertensia flowers in each site and plot in each week. This number was then merged with the Mertensia individuals to add the number of conspecifics variable.

```{r mert flower count manipulation,results="hide"}
mert.flower.counts<-flower.counts[(flower.counts$plant=="Mertensia fusiformis"),] #limit flower counts to Mertensia data
mert.counts.by.site<-aggregate(x=mert.flower.counts$total_flowers,by=list(mert.flower.counts$date,mert.flower.counts$site,mert.flower.counts$plot),FUN="mean") #calculate mean flower counts by week and site
colnames(mert.counts.by.site)<-c("date","site","plot.treat","number.conspecifics")

#changing class to adjust names
mert.counts.by.site$site<-as.character(mert.counts.by.site$site) 
mert.counts.by.site$plot.treat<-as.character(mert.counts.by.site$plot.treat)

#fixing names
mert.counts.by.site$site[mert.counts.by.site$site=="Avery Picnic"]<-"AveryPicnic"
mert.counts.by.site$site[mert.counts.by.site$site=="Stupid Falls"]<-"StupidFalls"
mert.counts.by.site$site[mert.counts.by.site$site=="Wash 3C"]<-"WG3C"
mert.counts.by.site <-mert.counts.by.site[!(mert.counts.by.site$plot.treat=="Kaysee"),]
mert.counts.by.site$plot.treat[mert.counts.by.site$plot.treat=="Control"]<-"control"
mert.counts.by.site$plot.treat[mert.counts.by.site$plot.treat=="Manipulated"]<-"manip"

#calculating week numbers in preparation for the merge
mert$week.estimate<-strftime(mert$midpoint, format = "%V") 
mert.counts.by.site$week.estimate<-strftime(mert.counts.by.site$date, format = "%V")

mert<-merge(mert,mert.counts.by.site, by.x = c("site","plot.treat","week.estimate"), by.y = c("site","plot.treat","week.estimate")) #merging by site, plot treatment, and week estimate
```

### Delphinium

The same was repeated for Delphinium.

```{r delph flower count manipulation, results="hide"}
delph.flower.counts<-flower.counts[(flower.counts$plant=="Delphinium nuttallianum"),] #limit flower counts to Delphinium data
delph.counts.by.site<-aggregate(x=delph.flower.counts$total_flowers,by=list(delph.flower.counts$date,delph.flower.counts$site,delph.flower.counts$plot),FUN="mean") #calculate mean flower counts by week and site
colnames(delph.counts.by.site)<-c("date","site","plot.treat","number.conspecifics")

#changing class to adjust names
delph.counts.by.site$site<-as.character(delph.counts.by.site$site) 
delph.counts.by.site$plot.treat<-as.character(delph.counts.by.site$plot.treat)

#fixing names
delph.counts.by.site$site[delph.counts.by.site$site=="Rustlers Gulch"]<-"RustlersGulch" 
delph.counts.by.site$site[delph.counts.by.site$site=="Wash 3C"]<-"WG3C"
delph.counts.by.site <-delph.counts.by.site[!(delph.counts.by.site$plot.treat=="Kaysee"),]
delph.counts.by.site$plot.treat[delph.counts.by.site$plot.treat=="Control"]<-"control"
delph.counts.by.site$plot.treat[delph.counts.by.site$plot.treat=="Manipulated"]<-"manip"

#calculating week numbers in preparation for the merge
delph$week.estimate<-strftime(delph$midpoint, format = "%V") 
delph.counts.by.site$week.estimate<-strftime(delph.counts.by.site$date, format = "%V")

delph<-merge(delph,delph.counts.by.site, by.x = c("site","plot.treat","week.estimate"), by.y = c("site","plot.treat","week.estimate")) #merging by site, plot treatment, and week estimate
```

### Potentilla

The same was done for Potentilla.

```{r pot flower count manipulation, results="hide"}
pot.flower.counts<-flower.counts[(flower.counts$plant=="Potentilla pulcherrima"),] #limit flower counts to Potentilla data
pot.counts.by.site<-aggregate(x=pot.flower.counts$total_flowers,by=list(pot.flower.counts$date,pot.flower.counts$site,pot.flower.counts$plot),FUN="mean") #calculate mean flower counts by week and site
colnames(pot.counts.by.site)<-c("date","site","plot.treat","number.conspecifics")

#changing class to adjust names
pot.counts.by.site$site<-as.character(pot.counts.by.site$site) 
pot.counts.by.site$plot.treat<-as.character(pot.counts.by.site$plot.treat)

#fixing names
pot.counts.by.site$site[pot.counts.by.site$site=="Rustlers Gulch"]<-"RustlersGulch" 
pot.counts.by.site$site[pot.counts.by.site$site=="Wash 3C"]<-"WG3C"
pot.counts.by.site$site[pot.counts.by.site$site=="Bellview Bench"]<-"BellviewBench"
pot.counts.by.site$site[pot.counts.by.site$site=="Avery Picnic"]<-"AveryPicnic"
pot.counts.by.site$site[pot.counts.by.site$site=="Stupid Falls"]<-"StupidFalls"
pot.counts.by.site <-pot.counts.by.site[!(pot.counts.by.site$plot.treat=="Kaysee"),]
pot.counts.by.site$plot.treat[pot.counts.by.site$plot.treat=="Control"]<-"control"
pot.counts.by.site$plot.treat[pot.counts.by.site$plot.treat=="Manipulated"]<-"manip"

#calculating week numbers in preparation for the merge
pot$week.estimate<-strftime(pot$midpoint, format = "%V") 
pot.counts.by.site$week.estimate<-strftime(pot.counts.by.site$date, format = "%V")

pot<-merge(pot,pot.counts.by.site, by.x = c("site","plot.treat","week.estimate"), by.y = c("site","plot.treat","week.estimate")) #merging by site, plot treatment, and week estimate
```


# Mixed Effects Models with Count Data

Generalized linear mixed effects models were appropriate for this analysis because the data contain sources of non-independence. Individual plants were located in the same site as other individuals and were likely genetically similar. Therefore, we considered site a random effect. 

The response variable is total seeds, which is discrete and non-zero. The interaction between deviation and the early/late factor was a fixed effect, as well as the interaction between plot treatment and conspecific density. Flower number is included (but not assessed) in the interaction terms to account for the effect of the number of flowers on number of seeds. We would have included soil moisture as a covariate and fixed effect in our model, but preliminary analyses involving model selection did not identify soil moisture as a significant driver of seed production. Each species is analyzed separately. 

## Mertensia

We started by limiting the individuals to the open treatment (excluding the hand-pollinated treatment) and by checking the distribution of the total seed counts.

```{r creating mert open}
mert.open<-mert[(mert$treat=="open"),] #removed hand pollination treatment
```

```{r limiting Mertensia to open, include=FALSE}
mert.nbinom<-fitdist(mert.open$dev.seed, "nbinom") #fitting Mertensia data to negative binomial distribution using fitdistplus
```

```{r mert neg binom plot}
plot(mert.nbinom) #plotting to see the fit
```

The Mertensia seed data fits a negative binomial distribution. The glmmTMB package is a good package for modeling data with a negative binomial. The glmmTMB package is also suitable for data that could be overdispersed or zero-inflated.

### Main Model

```{r Mertensia glmmtmb with relative position, warning=FALSE}
#mert.glmmtmb<-glmmTMB(dev.seed ~ flowers:(deviation*early.late) + flowers:number.conspecifics/plot.treat  + (1|site), family = "nbinom2", data = mert.open) #putting count data into glmmTMB for DHARMa package
#summary(mert.glmmtmb) #summary of glmmTMB model

#mert.counts.simulation<-simulateResiduals(fittedModel = mert.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
#plot(mert.counts.simulation) #plotting simulation
#testDispersion(mert.counts.simulation) #checking for overdispersion
#testZeroInflation(mert.counts.simulation) #checking for zero inflation
```

We detected a significant effect of early vs. late blooming on the total number of seeds in Mertensia individuals, but when we checked for overdispersion and zero-inflation in the data using the DHARMa package, the data were slightly zero-inflated. To address this, we adjusted our glmmtmb model to include zero-inflation.

```{r correcting mert counts glmmtmb, warning=FALSE, message=FALSE}
mert.glmmtmb<-glmmTMB(dev.seed ~ flowers:(deviation*early.late) + flowers:number.conspecifics/plot.treat  + (1|site), ziformula=~1, family = "nbinom2", data = mert.open) #putting count data into glmmTMB for DHARMa package
summary(mert.glmmtmb) #summary of glmmTMB model

mert.counts.simulation<-simulateResiduals(fittedModel = mert.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.counts.simulation) #plotting simulation
testDispersion(mert.counts.simulation) #checking for overdispersion
testZeroInflation(mert.counts.simulation) #checking for zero inflation
```
When number of flowers is taken into account, seed set for Mertensia individuals may be affected by blooming before or after the population peak. Zero-inflation is accounted for in the new model, and the model for Mertensia count data is no longer zero-inflated. 

To figure out the direction of the effect, we looked at the plots (see "Figures"). **Blooming after the population peak may increase seed set for Mertensia individuals.**

### Pollen Limitation Model

To test the pollen limitation individuals, we created a separate fixed effects model. This model has site and plot treatment as random effects and the interaction between pollen limitation treatment and number of flowers as a fixed effect. We included this interaction because the difference in seed set between the open and hand treatments is heavily dependent on the number of flowers. The interaction accounts for the wide variation of number of flowers and ultimately developed seeds. The response variable is still total number of developed seeds in Mertensia individuals.

```{r Mert glmmtmb pollen treat, warning=FALSE}
#mert.treat.glmmtmb<-glmmTMB(dev.seed ~ treat/flowers + (1|site/plot.treat), family = "nbinom2", data = mert) #Mertensia model for negative binomial data with glmmTMB package
#summary(mert.treat.glmmtmb) #summary of model output

#mert.counts.treat.simulation<-simulateResiduals(fittedModel = mert.treat.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
#plot(mert.counts.treat.simulation) #plotting simulation
#testDispersion(mert.counts.treat.simulation) #checking for overdispersion
#testZeroInflation(mert.counts.treat.simulation) #checking for zero inflation
```

We detected an effect of pollen limitation treatment on Mertensia total developed seeds, but we had to test the model assumptions of our pollen limitation model as well. The data in the pollen limitation model for Mertensia are not overdispersed, but they are zero-inflated. We then adjusted our model to include zero-inflation and ran the overdispersion and zero-inflation tests again.

```{r Mert new glmmtmb pollen treat, warning=FALSE, message=FALSE}
mert.treat.glmmtmb<-glmmTMB(dev.seed ~ treat/flowers + (1|site/plot.treat), ziformula=~1, family = "nbinom2", data = mert) #Mertensia model for negative binomial data with glmmTMB package
summary(mert.treat.glmmtmb) #summary of model output

mert.counts.treat.simulation<-simulateResiduals(fittedModel = mert.treat.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.counts.treat.simulation) #plotting simulation
testDispersion(mert.counts.treat.simulation) #checking for overdispersion
testZeroInflation(mert.counts.treat.simulation) #checking for zero inflation
```
The data are no longer zero-inflated, and we still detected an effect of pollen limitation on the Mertensia seed counts. **Mertensia individuals are pollen-limited.**

### Figures

Below is the plot of seed set vs. relative position of blooming in the population for Mertensia individuals. Plot treatment is indicated by individual color.

```{r Mertensia plot, message=FALSE,warning=FALSE}
ggplot(mert.open, aes(x=mert.open$relative.position, y=mert.open$dev.seed, group=mert.open$plot.treat)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Mertensia Blooming Time on Total Developed Seeds") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r Mertensia linear plot, message=FALSE,warning=FALSE}
ggplot(mert.open, aes(x=mert.open$relative.position, y=mert.open$dev.seed, group=mert.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Mertensia Blooming Time on Total Developed Seeds") +
  theme_classic() +
  geom_point(aes(color=early.late),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  geom_smooth(method = "glm", aes(color=early.late))
```

We then plotted the interaction between deviation and early/late instead of relative position in order to fit a linear model.

```{r Mertensia plot substituting relative position, warning=FALSE, message=FALSE}
ggplot(mert.open, aes(x=mert.open$deviation, y=mert.open$dev.seed/mert.open$flowers, group= mert.open$early.late)) +
  labs(y="Total Developed Seeds per Flower",x="Days Relative to Population Peak Bloom", title="Mertensia") +
  theme_classic() +
  scale_x_continuous(breaks=seq(0,9,1)) +
  geom_point(size=3, alpha = 0.8, aes(color=early.late,shape=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak",shape="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  scale_shape_manual(labels= c("before peak","after peak"), values = c("early"="circle","late"="triangle")) +
  geom_text(x=7,y=2,label="p = 0.088")
```

Then we plotted the effect of conspecific density and plot treatment on total developed seeds.

```{r Mertensia plot with conspecific density, warning=FALSE, message=FALSE}
ggplot(mert.open, aes(x=mert.open$number.conspecifics, y=mert.open$dev.seed/mert.open$flowers, group= mert.open$plot.treat)) +
  labs(y="Total Developed Seeds per Flower",x="Conspecific Density", title="Mertensia") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat,shape=plot.treat)) +
  geom_smooth(method="glm",linetype="dashed",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment",shape="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue")) +
  scale_shape_manual(labels= c("control","accelerated snowmelt"), values = c("control"="circle","manip"="triangle"))
```

Finally, we plotted all of the data with the pollinator active period. The pollinator active period was the time during which we saw interactions between pollinators and our species. The active period is shaded.

```{r Mertensia poll act plot, warning=FALSE, message=FALSE}
mert$midpoint2<-format(as.Date(mert$midpoint), format="%m-%d")

ggplot(mert, aes(x=mert$midpoint2, y=mert$dev.seed/mert$flowers, group= mert$treat)) +
  labs(y="Total Developed Seeds per Flower",x="Date", title="Effect of Mertensia Blooming Time and Pollinator Activity on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin="06-19", xmax="07-03",ymin=0,ymax=Inf,alpha=0.1)
```


## Delphinium

For Delphinium, we again limited the individuals to open treatment individuals.

```{r creating delph open}
delph.open<-delph[(delph$treat=="open"),] #removed hand pollination treatment
```

```{r checking distribution, include=FALSE}
delph.nbinom<-fitdist(delph.open$total.seeds, "nbinom") #fitting negative binomial distribution using fitdistplus package
```

```{r delph neg binom fit}
plot(delph.nbinom) #plotting distribution fit
```

The Delphinium data fits a negative binomial distribution. We used the glmmTMB package again.

### Main Model

```{r Delphinium glmmTMB,warning=FALSE,message=FALSE}
delph.glmmtmb<-glmmTMB(total.seeds ~ X.flowers:(deviation*early.late) + X.flowers:number.conspecifics/plot.treat + (1|site), family = "nbinom2", data = delph.open) #Delphinium model for negative binomial data with glmmTMB package
#removed treat fixed effect (only open)
summary(delph.glmmtmb) #summary of model output

delph.counts.simulation<-simulateResiduals(fittedModel = delph.glmmtmb) #creating simulation for Delphinium mixed effects model with DHARMa package
plot(delph.counts.simulation) #plotting simulation
testDispersion(delph.counts.simulation) #checking for overdispersion
testZeroInflation(delph.counts.simulation) #checking for zero inflation
```

When flower number is taken into account, deviation from the population peak has a significant effect on Delphinium developed seed count. We tested the model assumptions as we did with Mertensia seed count data. The model for the Delphinium count data is not overdispersed or zero-inflated.

To determine the direction of deviation effect, we looked at the plot. **When flower number is taken into account, seed set of Delphinium individuals increases with deviation from the population peak.**

### Pollen Limitation Model

Again, we tested the pollen limitation in a separate mixed effects model. 

```{r Delph glmmtmb pollen treat,warning=FALSE}
#delph.treat.glmmtmb<-glmmTMB(total.seeds ~ treat/X.flowers + (1|site/plot.treat), family = "nbinom2", data = delph) #Mertensia model for negative binomial data with glmmTMB package
#summary(delph.treat.glmmtmb) #summary of model output

#delph.counts.treat.simulation<-simulateResiduals(fittedModel = delph.treat.glmmtmb) #creating simulation for Delphinium mixed effects model with DHARMa package
#plot(delph.counts.treat.simulation) #plotting simulation
#testDispersion(delph.counts.treat.simulation) #checking for overdispersion
#testZeroInflation(delph.counts.treat.simulation) #checking for zero inflation
```
We detected an effect of pollen limitation on the total developed seeds of Delphinium individuals. We again checked for overdispersion and zero-inflation in the pollen limitation data. The Delphinum pollen limitation model is zero-inflated. We adjusted our model to include the zero-inflation formula.

```{r Delph new glmmtmb pollen treat,warning=FALSE,message=FALSE}
delph.treat.glmmtmb<-glmmTMB(total.seeds ~ treat/X.flowers + (1|site/plot.treat), ziformula=~1, family = "nbinom2", data = delph) #Mertensia model for negative binomial data with glmmTMB package
summary(delph.treat.glmmtmb) #summary of model output

delph.counts.treat.simulation<-simulateResiduals(fittedModel = delph.treat.glmmtmb) #creating simulation for Delphinium mixed effects model with DHARMa package
plot(delph.counts.treat.simulation) #plotting simulation
testDispersion(delph.counts.treat.simulation) #checking for overdispersion
testZeroInflation(delph.counts.treat.simulation) #checking for zero inflation
```

The new model is not zero-inflated. We still see an effect of pollen limitation on the Delphinium count data. **Delphinium individuals are pollen-limited.**

### Figures

Below are the plots for the Delphinium individuals.

```{r Delphinium plot,message=FALSE,warning=FALSE}
ggplot(delph.open, aes(x=delph.open$relative.position, y=delph.open$total.seeds, group=plot.treat)) +
  labs(title="Effect of Delphinium Blooming Time on Total Developed Seeds", y="Total Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r delph linear plot, message=FALSE,warning=FALSE}
ggplot(delph.open, aes(x=delph.open$relative.position, y=delph.open$total.seeds, group=delph.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Delphinium Blooming Time on Total Developed Seeds") +
  theme_classic() +
  geom_point(aes(color=early.late),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  geom_smooth(method = "glm", aes(color=early.late))
```

```{r delphinium plot substituting relative position,warning=FALSE, message=FALSE}
ggplot(delph.open, aes(x=delph.open$deviation, y=(delph.open$total.seeds/delph.open$X.flowers), group= delph.open$early.late)) +
  labs(y="Total Developed Seeds per Flower",x="Days Relative to Population Peak Bloom", title="Delphinium") +
  theme_classic() +
  scale_x_continuous(breaks=seq(0,10,1)) +
  geom_point(size=3, alpha = 0.8, aes(color=early.late,shape=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak",shape="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  scale_shape_manual(labels= c("before peak","after peak"), values = c("early"="circle","late"="triangle")) +
  geom_text(x=9,y=30,label="p = 0.025")
```


```{r Delphinium plot with conspecific density,warning=FALSE, message=FALSE}
ggplot(delph.open, aes(x=delph.open$number.conspecifics, y=delph.open$total.seeds/delph.open$X.flowers, group= delph.open$plot.treat)) +
  labs(y="Total Developed Seeds per Flower",x="Conspecific Density", title="Delphinium") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat,shape=plot.treat)) +
  geom_smooth(method="glm",linetype="dashed",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment",shape="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue")) +
  scale_shape_manual(labels= c("control","accelerated snowmelt"), values = c("control"="circle","manip"="triangle"))
```

Finally, we plotted the pollinator activity period with the total number of developed seeds and midpoint of individuals.

```{r delph poll act plot, warning=FALSE, message=FALSE}
delph$midpoint2<-format(as.Date(delph$midpoint), format="%m-%d")

ggplot(delph, aes(x=delph$midpoint2, y=delph$total.seeds/delph$X.flowers, group= delph$treat)) +
  labs(y="Total Developed Seeds per Flower",x="Date", title="Effect of Delphinium Blooming and Pollinator Activity on Total Developed Seeds") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin="06-27", xmax="07-18",ymin=0,ymax=Inf,alpha=0.1)
```

## Potentilla

We began by limiting the data to the open treatment Potentilla individuals.

```{r limiting potentilla to open}
pot.open<-pot[(pot$treat=="open"),] #removed hand pollination treatment
```

```{r checking potentilla distribution, include=FALSE}
pot.nbinom<-fitdist(pot.open$total.seeds, "nbinom") #fitting negative binomial distribution using fitdistplus package
```

```{r pot neg binom fit}
plot(pot.nbinom) #plotting distribution fit
```
The Potentilla seed data fits a negative binomial distribution. We used the glmmTMB package again.

### Main Model

```{r Potentilla glmmtmb,warning=FALSE}
#pot.glmmtmb<-glmmTMB(total.seeds ~ X.flowers:(deviation * early.late) + X.flowers:number.conspecifics/plot.treat + (1|site), family = "nbinom2", data = pot.open) #Potentilla model for negative binomial data with glmmTMB package
#summary(pot.glmmtmb) #summary of model output

#pot.counts.simulation<-simulateResiduals(fittedModel = pot.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
#plot(pot.counts.simulation) #plotting simulation
#testDispersion(pot.counts.simulation) #checking for overdispersion
#testZeroInflation(pot.counts.simulation) #checking for zero inflation
```
The Potentilla data are not overdispersed, but they are zero-inflated. To fix this, we had to include zero inflation in our model and again check for zero-inflation.

```{r Potentilla new glmmtmb,warning=FALSE, message=FALSE}
pot.glmmtmb<-glmmTMB(total.seeds ~ X.flowers:(deviation * early.late) + X.flowers:number.conspecifics/plot.treat + (1|site), ziformula=~1, family = "nbinom2", data = pot.open) #new Potentilla model for negative binomial data with glmmTMB package
summary(pot.glmmtmb) #summary of model output

pot.counts.simulation<-simulateResiduals(fittedModel = pot.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
plot(pot.counts.simulation) #plotting simulation
testDispersion(pot.counts.simulation) #checking for overdispersion
testZeroInflation(pot.counts.simulation) #checking for zero inflation
```
When we incorporated zero-inflation into the model, we found a significant effect of deviation from the population peak, blooming before vs after the peak, and the interaction between the two. The direction of the effect, however, must be determined from the plots (see "Figures").

After looking at the plots, we see that **when we account for the number of flowers, blooming after the peak lowers seed set and deviation has a more negative effect on the late blooming Potentilla individuals.**

### Pollen Limitation Model

We assessed pollen limitation for Potentilla in a mixed effects model. 

```{r Pot glmmtmb pollen treat,warning=FALSE}
#pot.treat.glmmtmb<-glmmTMB(total.seeds ~ treat/X.flowers + (1|site/plot.treat), family = "nbinom2", data = pot) #Potentilla model for negative binomial data with glmmadmb package
#summary(pot.treat.glmmtmb) #summary of model output

#pot.counts.treat.simulation<-simulateResiduals(fittedModel = pot.treat.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
#plot(pot.counts.treat.simulation) #plotting simulation
#testDispersion(pot.counts.treat.simulation) #checking for overdispersion
#testZeroInflation(pot.counts.treat.simulation) #checking for zero inflation
```

We detected a significant effect of the pollen limitation treatment on the total number of developed seeds for Potentilla individuals, but the Potentilla pollen limitation data were zero-inflated. We again included the zero-inflation formula into our models. 

```{r Pot new glmmtmb pollen treat,warning=FALSE,message=FALSE}
pot.treat.glmmtmb<-glmmTMB(total.seeds ~ treat/X.flowers + (1|site/plot.treat), ziformula=~1, family="nbinom2",data = pot) #Potentilla model for negative binomial data with glmmadmb package
summary(pot.treat.glmmtmb) #summary of model output

pot.counts.treat.simulation<-simulateResiduals(fittedModel = pot.treat.glmmtmb) #creating simulation for Potentilla mixed effects model with DHARMa package
plot(pot.counts.treat.simulation) #plotting simulation
testDispersion(pot.counts.treat.simulation) #checking for overdispersion
testZeroInflation(pot.counts.treat.simulation) #checking for zero inflation
```

The data are no longer zero-inflated, and we don't have strong evidence for pollen limitation in the Potentilla individuals. **Potentilla individuals are not pollen-limited.**

### Figures

Below are the plots for Potentilla individuals.

```{r Potentilla plot,message=FALSE,warning=FALSE}
ggplot(pot.open, aes(x=pot.open$relative.position, y=pot.open$total.seeds, group=plot.treat)) +
  labs(title="Effect of Potentilla Blooming Time on Total Developed Seeds", y="Total Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r pot linear plot, message=FALSE,warning=FALSE}
ggplot(pot.open, aes(x=pot.open$relative.position, y=pot.open$total.seeds, group=pot.open$early.late)) +
  labs(y="Total Developed Seeds",x="Days Relative to Population Peak Bloom", title="Effect of Potentilla Blooming Time on Total Developed Seeds") +
  theme_classic() +
  geom_point(aes(color=early.late),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  geom_smooth(method = "glm", aes(color=early.late))
```

```{r potentilla plot substituting relative position,warning=FALSE, message=FALSE}
ggplot(pot.open, aes(x=pot.open$deviation, y=pot.open$total.seeds/pot.open$X.flowers, group= pot.open$early.late)) +
  labs(y="Total Developed Seeds per Flower",x="Days Relative to Population Peak Bloom",title="Potentilla") +
  theme_classic() +
  scale_x_continuous(breaks=seq(0,24,2)) +
  geom_point(size=3, alpha = 0.8, aes(color=early.late,shape=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak",shape="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  scale_shape_manual(labels= c("before peak","after peak"), values = c("early"="circle","late"="triangle")) +
  geom_text(x=22,y=17,label="p < 0.01")
```

```{r Potentilla plot with conspecific density,warning=FALSE, message=FALSE}
ggplot(pot.open, aes(x=pot.open$number.conspecifics, y=pot.open$total.seeds/pot.open$X.flowers, group= pot.open$plot.treat)) +
  labs(y="Total Developed Seeds per Flower",x="Conspecific Density", title="Potentilla") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat,shape=plot.treat)) +
  geom_smooth(method="glm",linetype="dashed",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment",shape="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue")) +
  scale_shape_manual(labels= c("control","accelerated snowmelt"), values = c("control"="circle","manip"="triangle"))
```

Again we plotted the pollinator activity period.

```{r pot poll act plot, warning=FALSE, message=FALSE}
ggplot(pot,aes(x=as.Date.factor(pot$midpoint), y=pot$total.seeds/pot$X.flowers, group= pot$treat)) +
  labs(y="Total Developed Seeds per Flower",x="Date", title="Pollinator Activity Period and Total Developed Seeds in Potentilla") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin=as.Date.character("2019-07-05"), xmax=as.Date.character("2019-08-24"),ymin=0,ymax=Inf,alpha=0.1) +
  scale_x_date(date_breaks = "3 days", date_labels = "%m/%d")
```

# Mixed Effects Models with Proportion Data

Only the Mertensia and Delphinium data included proportion of developed seeds to undeveloped ovules. When counting seeds for the Potentilla individuals, undeveloped ovules were difficult to distinguish from other elements of the carpel and were not included. Because the data are proportions and we are using the cbind function, we assume a binomial distribution. 

## Mertensia

First, we had to calculate undeveloped seeds to use the cbind function for our proportion of developed seeds.
```{r checking binom dist, include=FALSE}
mert.binom<-fitdist(mert.open$prop.dev.seeds, "norm",start = NULL) #fitting Mertensia data to binomial distribution with normal errors using fitdistplus
```

```{r mert binom fit}
plot(mert.binom) #plotting to see the fit
```

```{r Mertensia undeveloped seeds, warning=FALSE, message=FALSE}
mert.open$undev.seeds<-(mert.open$total.seeds-mert.open$dev.seed) #creating an undeveloped seed column for cbind

mert$undev.seeds<-(mert$total.seeds-mert$dev.seed) #creating an undeveloped seed column for cbind
```

### Main Model

Below is the mixed effects model for the proportion of developed seeds. The individuals are limited to the open treatment. 

```{r Mertensia proportion model,warning=FALSE,message=FALSE}
Mert.prop.glmmtmb<-glmmTMB(cbind(dev.seed,undev.seeds) ~ flowers:(deviation * early.late) + flowers:number.conspecifics/plot.treat + (1|site), family = binomial, data = mert.open) #Mertensia model with proportion of developed seeds using the glmmTMB package
summary(Mert.prop.glmmtmb)

mert.prop.simulation<-simulateResiduals(fittedModel = Mert.prop.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.prop.simulation) #plotting simulation
testDispersion(mert.prop.simulation) #checking for overdispersion
testZeroInflation(mert.prop.simulation)
```

We found a significant effect of deviation from the population peak on the proportion of developed seeds in Mertensia individuals. The Mertensia proportion data were also not overdispersed or zero-inflated. After looking at the plots below, we see that **when flower number was taken into account, Mertensia individuals that deviated from the population peak had higher seed set.**

### Pollen Limitation Model

Next, we created the pollen limitation model for the Mertensia developed seeds. The model includes site and plot treatment as random effects like the models above. Now the proportion of developed seeds is the response variable.

```{r Mert prop pollen treat,warning=FALSE, message=FALSE}
Mert.prop.treat.glmmtmb<-glmmTMB(cbind(dev.seed,undev.seeds) ~ treat/flowers + (1|site/plot.treat), family = binomial, data = mert) #model with pollen lim treatment and proportion of developed seeds using the glmmTMB package
summary(Mert.prop.treat.glmmtmb) #summary of model results

mert.prop.treat.simulation<-simulateResiduals(fittedModel = Mert.prop.treat.glmmtmb) #creating simulation for Mertensia mixed effects model with DHARMa package
plot(mert.prop.treat.simulation) #plotting simulation
testDispersion(mert.prop.treat.simulation) #checking for overdispersion
testZeroInflation(mert.prop.treat.simulation) #checking for zero inflation
```

We didn't detected a significant effect of pollen supplementation on the proportions of developed seeds for Mertensia individuals. We again checked to see if the data were overdispersed or zero-inflated, and they were not. **While the total seed set indicated pollen limitation, we did not detect pollen limitation in the proportion of developed seeds in Mertensia.**

### Figures

Below are the plots for Mertensia proportion data.

```{r Mertensia proportion plot,message=FALSE,warning=FALSE}
mert.open<-mert.open[!is.na(mert.open$prop.dev.seeds),] #removing NA values from proportion column

ggplot(mert.open, aes(x=mert.open$relative.position, y=mert.open$prop.dev.seeds, group=plot.treat)) +
  labs(y="Proportion of Developed Seeds",x="Days Relative to Population Peak Bloom",title="Effect of Mertensia Blooming Time on Proportion of Developed Seeds") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r Mertensia deviation proportion plot,warning=FALSE, message=FALSE}
ggplot(mert.open, aes(x=mert.open$deviation, y=mert.open$prop.dev.seeds/mert.open$flowers, group= mert.open$early.late)) +
  labs(y="Proportion of Developed Seeds per Flower",x="Days Relative to Population Peak Bloom",title="Mertensia") +
  theme_classic() +
  scale_x_continuous(breaks=seq(0,8,1)) +
  geom_point(size=3, alpha = 0.8, aes(color=early.late,shape=early.late)) +
  geom_smooth(method="glm",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak",shape="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  scale_shape_manual(labels= c("before peak","after peak"), values = c("early"="circle","late"="triangle")) +
  geom_text(x=7,y=0.06,label="p = 0.019")
```


```{r mertensia plot conspecifics and proportions,warning=FALSE, message=FALSE}
ggplot(mert.open, aes(x=mert.open$number.conspecifics, y=mert.open$prop.dev.seeds/mert.open$flowers, group= mert.open$plot.treat)) +
  labs(y="Proportion of Developed Seeds per Flower",x="Conspecific Density",title="Mertensia") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat,shape=plot.treat)) +
  geom_smooth(method="glm",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment",shape="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue")) +
  scale_shape_manual(labels= c("control","accelerated snowmelt"), values = c("control"="circle","manip"="triangle")) +
  geom_text(x=160,y=0.06,label="p < 0.01")
```

Finally, we added pollinator activity.

```{r Mertensia prop poll act plot, message=FALSE, warning=FALSE}
ggplot(mert, aes(x=as.Date.factor(mert$midpoint), y=mert$prop.dev.seeds/mert$flowers, group= mert$treat)) +
  labs(y="Proportion of Developed Seeds per Flower",x="Date", title="Pollinator Activity Period and Proportion of Developed Seeds in Mertensia") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin=as.Date.character("2019-06-19"), xmax=as.Date.character("2019-07-03"),ymin=0,ymax=Inf,alpha=0.1) +
  scale_x_date(date_breaks = "3 days", date_labels = "%m/%d")
```

## Delphinium

We checked the fit of the Delphinium data with binomial errors.

```{r checking delph binom dist, include=FALSE}
delph.binom<-fitdist(delph.open$prop.dev.seeds, "norm") #fitting delphinium data to binomial distribution with normal errors using fitdistplus
```

```{r delph binom fit}
plot(delph.binom) #plotting to see the fit
```

### Main Model

We assessed the Delphinium data with a mixed effects model for the proportion of developed seeds. The individuals are still limited to the open treatment. 

```{r delphinium proportion model, warning=FALSE,message=FALSE}
Delph.prop.glmmtmb<-glmmTMB(cbind(dev.seed.total,undev.seed.total) ~ X.flowers:(deviation * early.late) + X.flowers:number.conspecifics/plot.treat + (1|site), family = betabinomial, data = delph.open) #modeling Delphinium proportion of developed seeds with glmmTMB package
summary(Delph.prop.glmmtmb)

delph.prop.simulation<-simulateResiduals(fittedModel = Delph.prop.glmmtmb) #creating simulation for Delphinium model
plot(delph.prop.simulation) #plotting simulation
testDispersion(delph.prop.simulation) #checking for overdispersion
testZeroInflation(delph.prop.simulation) #checking for zero inflation
```

The seed set of Delphinium individuals wasn't significantly affected by relative blooming time and conspecific density. Our model was overdispersed to binomial errors, but not to betabinomial errors.  **Relative blooming time and conspecific density do not have an effect on the proportion of developed seeds in Delphinium individuals.**


### Pollen Limitation Model

We created the mixed effects model for the pollen-supplemented Delphinium individuals. Like the Mertensia model above, site and plot treatment are random effects, the interaction between pollen limitation treatment and number of flowers is the fixed effect, and proportion of developed seeds is the response variable.

```{r delph prop pollen lim model, warning=FALSE}
Delph.prop.treat.glmmtmb<-glmmTMB(cbind(dev.seed.total,undev.seed.total) ~ treat/X.flowers + (1|site/plot.treat), family = betabinomial, data = delph) #modeling pollen lim and proportion of developed seeds with glmmTMB package
summary(Delph.prop.treat.glmmtmb) #model summary

delph.prop.treat.simulation<-simulateResiduals(fittedModel = Delph.prop.treat.glmmtmb) #creating simulation for Delphinium model
plot(delph.prop.treat.simulation) #plotting simulation
testDispersion(delph.prop.treat.simulation) #checking for overdispersion
testZeroInflation(delph.prop.treat.simulation) #checking for zero inflation
```

Delphinium proportions of developed seeds were significantly affected by pollen supplementation, and the data were overdispersed to the binomial, but not to betabinomial errors. **As shown with total developed seeds, Delphinium individuals are pollen-limited in this system.**

### Figures

Below are the plots for the proportion of developed seeds in Delphinium individuals.

```{r Delphinium proportion plot,message=FALSE,warning=FALSE}
delph.open<-delph.open[!is.na(delph.open$prop.dev.seeds),] #removing NA values in proportion column
ggplot(delph.open, aes(x=delph.open$relative.position, y=delph.open$prop.dev.seeds, group=plot.treat)) +
  labs(title="Effect of Delphinium Blooming Time on Proportion of Developed Seeds", y="Proportion of Developed Seeds",x="Days Relative to Population Peak Bloom") +
  geom_point(aes(color=plot.treat),size=3, alpha = 0.8) +
  scale_color_brewer(palette="Dark2") + labs(color="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated"), values = c("control"="darkred","manip"="darkorange")) +
  geom_smooth()
```

```{r Delphinium deviation proportion plot,warning=FALSE, message=FALSE}
ggplot(delph.open, aes(x=delph.open$deviation, y=(delph.open$prop.dev.seeds/delph.open$X.flowers), group= delph.open$early.late)) +
  labs(y="Proportion of Developed Seeds per Flower",x="Days Relative to Population Peak Bloom",title="Delphinium") +
  theme_classic() +
  scale_x_continuous(breaks=seq(0,10,1)) +
  geom_point(size=3, alpha = 0.8, aes(color=early.late,shape=early.late)) +
  geom_smooth(method="glm",linetype="dashed",aes(color=early.late)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Before or After Peak",shape="Before or After Peak") +
  scale_color_manual(labels= c("before peak","after peak"), values = c("early"="darkred","late"="darkorange")) +
  scale_shape_manual(labels= c("before peak","after peak"), values = c("early"="circle","late"="triangle"))
```

```{r Delphinium plot conspecifics and proportions,warning=FALSE, message=FALSE}
ggplot(delph.open, aes(x=delph.open$number.conspecifics, y=delph.open$prop.dev.seeds/delph.open$X.flowers, group= delph.open$plot.treat)) +
  labs(y="Proportion of Developed Seeds per Flower",x="Conspecific Density",title="Delphinium") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=plot.treat,shape=plot.treat)) +
  geom_smooth(method="glm",linetype="dashed",aes(color=plot.treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Plot Treatment",shape="Plot Treatment") +
  scale_color_manual(labels= c("control","accelerated snowmelt"), values = c("control"="darkgreen","manip"="blue")) +
  scale_shape_manual(labels= c("control","accelerated snowmelt"), values = c("control"="circle","manip"="triangle"))+
  xlim(0,110)
```

Finally, we added pollinator activity.

```{r delph poll act prop plot, message=FALSE, warning=FALSE}
ggplot(delph, aes(x=as.Date.factor(delph$midpoint), y=delph$prop.dev.seeds/delph$X.flowers, group= delph$treat)) +
  labs(y="Proportion of Developed Seeds per Flower",x="Date", title="Pollinator Activity Period and Proportion of Developed Seeds in Delphinium") +
  theme_classic() +
  geom_point(size=3, alpha = 0.8, aes(color=treat)) +
  geom_smooth(aes(color=treat)) +
  scale_color_brewer(palette="Dark2") + 
  labs(color="Open or Hand-pollinated") +
  scale_color_manual(labels= c("open","open-hand"), values = c("open"="darkred","open-hand"="darkorange")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("rect",xmin=as.Date.character("2019-06-27"), xmax=as.Date.character("2019-07-18"),ymin=0,ymax=Inf,alpha=0.1) +
  scale_x_date(date_breaks = "3 days", date_labels = "%m/%d")
```


# Some last figures

## Pollen limitation

Some quick bar graphs to compare open and hand-pollinated treatment affected seed set in the three species.

```{r bar plot pollen lim, warning=FALSE}
#Mertensia plots with total developed seeds per flower and proportion of developed seeds per flower
ggplot(mert, aes(x=treat, y=dev.seed/flowers)) +
  labs(y="Total developed seeds", x="Pollen limitation treatment", title="Effect of pollen supplementation on Mertensia total developed seeds") +
  theme_classic() +
  geom_col()
ggplot(mert, aes(x=treat, y=prop.dev.seeds/flowers)) +
  labs(y="Proportion developed seeds", x="Pollen limitation treatment",title="Effect of pollen supplementation on Mertensia proportion of developed seeds") +
  theme_classic() +
  geom_col()

#Delphinium plots with total developed seeds per flower and proportion of developed seeds per flower
ggplot(delph, aes(x=treat, y=total.seeds/X.flowers)) +
  labs(y="Total developed seeds", x="Pollen limitation treatment",title="Effect of pollen supplementation on Delphinium total developed seeds") +
  theme_classic() +
  geom_col()
ggplot(delph, aes(x=treat, y=prop.dev.seeds/X.flowers)) +
  labs(y="Proportion developed seeds", x="Pollen limitation treatment",title="Effect of pollen supplementation on Delphinium proportion of developed seeds") +
  theme_classic() +
  geom_col()

#Potentilla plots with total developed seeds per flower
ggplot(pot, aes(x=treat, y=total.seeds/X.flowers)) +
  labs(y="Total developed seeds", x="Pollen limitation treatment",title="Effect of pollen supplementation on Potentilla total developed seeds") +
  theme_classic() +
  geom_col()
```

## Flower number figures

We created a few last figures to see the relationship between plot treatment and flower number (on the individuals, not conspecific density flower counts).

```{r plots showing relationship between plot treatment and number of flowers, warning=FALSE}
#number of Mertensia flowers in each plot treatment
ggplot(mert, aes(x=plot.treat, y=flowers)) +
  labs(y="Number of flowers", x="Plot treatment",title="Effect of plot treatment on Mertensia flower number") +
  theme_classic() +
  geom_col()
#number of Delphinium flowers in each plot treatment  
ggplot(delph,aes(x=plot.treat, y=X.flowers)) +
  labs(y="Number of flowers", x="Plot treatment",title="Effect of plot treatment on Delphinium flower number") +
  theme_classic() +
  geom_col()
#number of Potentilla flowers in each plot treatment
ggplot(pot,aes(x=plot.treat, y=X.flowers)) +
  labs(y="Number of flowers", x="Plot treatment",title="Effect of plot treatment on Potentilla flower number") +
  theme_classic() +
  geom_col()

```

# Session Info

```{r Session Info}
sessionInfo()
```

